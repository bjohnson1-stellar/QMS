# SIS Quality System Configuration
# Unified Document Intake & Quality Management

# =============================================================================
# UNIFIED INBOX CONFIGURATION
# =============================================================================
# ALL documents (drawings, specs, QM docs) drop here for automatic routing

inbox:
  path: "D:/Inbox"
  subdirs:
    needs_review: "NEEDS-REVIEW"
    conflicts: "CONFLICTS"
    duplicates: "DUPLICATES"

# =============================================================================
# DESTINATION PATHS
# =============================================================================

destinations:
  projects: "D:/Projects"
  quality_documents: "D:/Quality Documents"
  database: "D:/quality.db"
  vector_database: "D:/VectorDB"
  sqlite3: "C:/Users/bjohnson1/AppData/Local/Microsoft/WinGet/Packages/SQLite.SQLite_Microsoft.Winget.Source_8wekyb3d8bbwe/sqlite3.exe"

# =============================================================================
# EMBEDDING CONFIGURATION
# =============================================================================
# Supports two providers:
#   - "lm_studio": Requires LM Studio server running (faster if available)
#   - "local": Uses sentence-transformers directly (no server needed)
#   - "auto": Try LM Studio first, fall back to local

embeddings:
  provider: "auto"                  # "lm_studio", "local", or "auto"

  # LM Studio settings (when provider = lm_studio)
  base_url: "http://127.0.0.1:1234/v1"
  model: "text-embedding-nomic-embed-text-v1.5@q8_0"

  # Local sentence-transformers settings (when provider = local)
  local_model: "nomic-ai/nomic-embed-text-v1.5"  # HuggingFace model name
  device: null                      # "cuda", "cpu", or null for auto

  # Shared settings
  dimensions: 768                   # nomic-embed-text-v1.5 output dimensions
  batch_size: 32                    # Max documents per embedding request

# Legacy paths (kept for backwards compatibility)
paths:
  database: "D:/quality.db"
  sqlite3: "C:/Users/bjohnson1/AppData/Local/Microsoft/WinGet/Packages/SQLite.SQLite_Microsoft.Winget.Source_8wekyb3d8bbwe/sqlite3.exe"
  projects: "D:/Projects"
  # Legacy inbox paths - now unified to D:/Inbox
  inbox: "D:/Inbox"
  needs_review: "D:/Inbox/NEEDS-REVIEW"
  conflicts: "D:/Inbox/CONFLICTS"
  # Specification handling
  spec_inbox: "D:/Inbox"
  spec_needs_review: "D:/Inbox/NEEDS-REVIEW"
  specifications: "D:/Projects/_Specifications"
  # Calibration
  calibration: "D:/Projects/_Calibration"

# =============================================================================
# ARCHIVE & FOLDER HANDLING
# =============================================================================
# ZIP files and folders are extracted/scanned before classification

archive_handling:
  # Supported archive formats
  formats:
    - ".zip"
    - ".7z"      # Requires 7-Zip installed

  # Extract to temp location, process, then clean up
  extract_path: "D:/Inbox/_EXTRACTING"

  # After successful processing
  on_success: "delete"           # delete | archive | keep
  archive_processed: "D:/Inbox/_PROCESSED"

  # Nested archives (ZIP inside ZIP)
  max_depth: 2

folder_handling:
  # Process folders dropped in inbox
  enabled: true

  # After processing all files in folder
  on_success: "delete"           # delete | keep

  # Skip these folder names
  skip_folders:
    - "__MACOSX"
    - ".DS_Store"
    - "Thumbs.db"

# =============================================================================
# DOCUMENT TYPE DETECTION PATTERNS
# All patterns are configurable - modify as needed
# =============================================================================

document_types:
  # --- PROJECT DOCUMENTS ---
  drawings:
    patterns:
      - "^[PMSEIC]-\\d+"           # P-101, M-201, S-301, etc.
      - "^ISO-\\d+"                # ISO-001
      - "^\\d{5}[-_][PMSEIC]-"     # 07600_P-101
      - "^[RUHGAF]-\\d+"           # R-001 (Refrig), U-001 (Utility), etc.
    destination: "{projects}/{project}/{discipline}"
    handler: "sis-intake"

  specifications:
    patterns:
      - "^\\d{6}-.*_Rev[_.]"       # 242354-Title_Rev_01
      - "^\\d{6}.*\\.pdf$"         # CSI number prefix only
    destination: "{projects}/{project}/{drawing_set}/Specs"
    handler: "sis-spec-intake"

  # --- QUALITY MANAGEMENT DOCUMENTS ---
  qm_modules:
    patterns:
      - "^module.*\\.xml$"
    destination: "{quality_documents}/Modules"
    handler: "qm-intake"
    table: "qm_modules"

  procedures:
    prefix: "SP"                   # Standard Operating Procedures
    patterns:
      - "^SP-\\d+"
    destination: "{quality_documents}/Procedures"
    handler: "qm-intake"
    table: "qm_procedures"

  work_instructions:
    prefix: "WI"
    patterns:
      - "^WI-\\d+"
    destination: "{quality_documents}/Procedures"
    handler: "qm-intake"
    table: "qm_procedures"

  templates:
    prefix: "TP"
    patterns:
      - "^TP-\\d+"
    destination: "{quality_documents}/Templates"
    handler: "qm-intake"
    table: "qm_templates"

  forms:
    prefix: "FM"
    patterns:
      - "^FM-\\d+"
    destination: "{quality_documents}/Forms"
    handler: "qm-intake"
    table: "qm_forms"

  policies:
    prefix: "PL"
    patterns:
      - "^PL-\\d+"
    destination: "{quality_documents}/Policies"
    handler: "qm-intake"
    table: "qm_procedures"

  records:
    prefix: "RC"
    patterns:
      - "^RC-\\d+"
    destination: "{quality_documents}/Records/{year}"
    handler: "qm-intake"
    table: "qm_records"

  # --- WELDING PROGRAM DOCUMENTS ---
  wps:
    prefix: "WPS"
    patterns:
      - "^WPS-\\d+"                    # WPS-001, WPS-002
      - "^AWS-B2\\.1-\\d+"             # Standard WPS references
      - "^SWPS-\\d+"                   # Standard WPS
    destination: "{quality_documents}/Welding/WPS"
    handler: "weld-intake"
    table: "weld_wps"

  swps:
    prefix: "SWPS"
    patterns:
      - "^SWPS-\\d+"
      - "^AWS-B2\\.1-"
    destination: "{quality_documents}/Welding/WPS/SWPS"
    handler: "weld-intake"
    table: "weld_wps"

  fps:
    prefix: "FPS"
    patterns:
      - "^FPS-\\w+"                    # FPS-ORB-P08-001
      - "^Orbital[-_]?Fusion"          # Orbital Fusion procedures
    destination: "{quality_documents}/Welding/WPS/FPS"
    handler: "weld-intake"
    table: "weld_wps"

  pqr:
    prefix: "PQR"
    patterns:
      - "^PQR-\\d+"
    destination: "{quality_documents}/Welding/PQR"
    handler: "weld-intake"
    table: "weld_pqr"

  wpq:
    prefix: "WPQ"
    patterns:
      - "^WPQ-\\d+"
      - "^Welder-Qual-"
      - "^WQ-\\d+"
    destination: "{quality_documents}/Welding/WPQ"
    handler: "weld-intake"
    table: "weld_wpq"

  bps:
    prefix: "BPS"
    patterns:
      - "^BPS-\\d+"
    destination: "{quality_documents}/Welding/BPS"
    handler: "weld-intake"
    table: "weld_bps"

  bpq:
    prefix: "BPQ"
    patterns:
      - "^BPQ-\\d+"
      - "^BPQR-\\d+"
    destination: "{quality_documents}/Welding/BPQ"
    handler: "weld-intake"
    table: "weld_bpq"

  welder_records:
    patterns:
      - "^Welder-\\d+"
      - "^WR-\\d+"
    destination: "{quality_documents}/Welding/Welder-Records"
    handler: "weld-intake"
    table: "weld_welder_registry"

  continuity_log:
    patterns:
      - "^Continuity-Log-"
      - "^CL-\\d+"
    destination: "{quality_documents}/Welding/Continuity-Logs/{year}"
    handler: "weld-intake"
    table: "weld_continuity_log"

  production_weld_log:
    prefix: "PWL"
    patterns:
      - "^PWL-\\d+"                     # PWL-2026-W05 (Production Weld Log)
      - "^Weld-Log-\\d+"                # Weld-Log-07645-2026
      - "^Weekly[-_]?Weld"              # Weekly Weld Report
      - "^Jobsite[-_]?Weld"             # Jobsite Weld Log
    destination: "{quality_documents}/Welding/Production-Logs/{year}"
    handler: "weld-weekly-import"
    table: "weld_production_welds"

# =============================================================================
# MODEL ROUTING
# =============================================================================
# Route tasks to appropriate model based on complexity and importance

models:
  # Simple tasks: file routing, pattern matching, basic parsing
  simple:
    model: haiku
    tasks:
      - title_block_read
      - file_routing
      - manifest_update
      - pattern_matching
      - simple_table_extraction

  # Complex tasks: full extraction, conflict detection, report generation
  complex:
    model: sonnet
    tasks:
      - full_extraction
      - conflict_detection
      - cross_discipline_check
      - revision_comparison
      - report_generation

  # Critical tasks: validation, final decisions, quality review
  critical:
    model: opus
    tasks:
      - shadow_review
      - calibration
      - critical_conflict_resolution
      - quality_validation
      - ambiguous_routing

# =============================================================================
# DRAWING CLASSIFICATION
# =============================================================================

drawing_prefixes:
  # Prefix -> Discipline mapping
  "P-": Mechanical       # P&IDs, Process
  "M-": Mechanical       # Mechanical details
  "ISO-": Mechanical     # Isometrics
  "S-": Structural
  "E-": Electrical
  "EL-": Electrical
  "I-": Instrumentation
  "C-": Civil
  "A-": Architectural
  "G-": General          # GAs, Plot Plans
  "H-": HVAC
  "F-": Fire Protection
  "FP-": Fire Protection
  "R-": Refrigeration
  "RF-": Refrigeration
  "U-": Utility
  "UT-": Utility
  "PL-": Plumbing

discipline_prefixes:
  # Mechanical / Process
  P: "Mechanical"
  M: "Mechanical"
  ISO: "Mechanical"
  # Electrical (multiple sub-disciplines)
  E: "Electrical"
  EL: "Electrical"           # Lighting
  EP: "Electrical"           # Power
  EE: "Electrical"           # Environmental/Equipment
  ES: "Electrical"           # Special systems
  # Structural
  S: "Structural"
  # Instrumentation
  I: "Instrumentation"
  # Civil
  C: "Civil"
  CA: "Civil"
  # Architectural
  A: "Architectural"
  # General
  G: "General"
  GA: "General"
  # HVAC
  H: "HVAC"
  # Fire Protection
  F: "Fire-Protection"
  FP: "Fire-Protection"
  # Refrigeration
  R: "Refrigeration"
  RF: "Refrigeration"
  # Utility
  U: "Utility"
  UT: "Utility"
  # Plumbing
  PL: "Plumbing"
  PP: "Plumbing"             # Plumbing Process/Piping

drawing_types:
  # Keywords in title -> Drawing type
  "P&ID": P&ID
  "PIPING AND INSTRUMENT": P&ID
  "ISOMETRIC": ISO
  "ISO": ISO
  "GENERAL ARRANGEMENT": GA
  "PLAN": GA
  "ELEVATION": GA
  "SECTION": SECTION
  "DETAIL": DETAIL
  "SINGLE LINE": SLD
  "ONE LINE": SLD
  "WIRING": WIRING
  "INSTRUMENT LOOP": LOOP
  "STRUCTURAL": STRUCTURAL

# =============================================================================
# CSI DIVISION TO DRAWING SET MAPPING
# =============================================================================

csi_mapping:
  "01": "General"
  "07": "General"
  "10": "General"
  "22": "Plumbing"
  "23": "HVAC"
  "24": "Refrigeration"
  "26": "Electrical"
  "27": "Communications"
  "28": "Electronic-Safety"
  "33": "Utility"

# =============================================================================
# EXTRACTION SETTINGS
# =============================================================================

extraction:
  # Confidence thresholds
  thresholds:
    minimum_confidence: 0.6      # Below this, flag for review
    high_confidence: 0.9         # Above this, skip shadow review
    shadow_review_rate: 0.10     # 10% random sampling for Opus review

  # Line number parsing patterns (adjust per client standards)
  line_patterns:
    # Standard: SIZE-MATERIAL-NUMBER-SPEC
    - pattern: "^(\\d+)[\"-]?([A-Z]{1,4})-(\\d+)-([A-Z0-9]+)$"
      groups: [size, material, number, spec]
    # Alternative: NUMBER-SIZE-MATERIAL-SPEC
    - pattern: "^(\\d+)-(\\d+)[\"-]?([A-Z]{1,4})-([A-Z0-9]+)$"
      groups: [number, size, material, spec]

  # Material code mappings
  materials:
    CS: Carbon Steel
    SS: Stainless Steel
    SS304: Stainless Steel 304
    SS316: Stainless Steel 316
    AL: Aluminum
    CU: Copper
    PVC: PVC
    CPVC: CPVC
    PP: Polypropylene
    HDPE: HDPE
    GRP: Glass Reinforced Plastic
    CS-GAL: Galvanized Carbon Steel
    DI: Ductile Iron
    CI: Cast Iron

# =============================================================================
# CONFLICT DETECTION
# =============================================================================

conflicts:
  # What to check for
  checks:
    material_mismatch: true      # Same line, different materials
    size_mismatch: true          # Same line, different sizes
    tag_duplicate: true          # Same equipment tag, different specs
    missing_instrument: true     # Instrument on P&ID not on loop diagram
    weld_inconsistency: true     # Weld specs don't match
    cross_discipline: true       # Structural vs Mechanical conflicts

  # Severity rules
  severity_rules:
    # Critical: Safety implications
    - condition: "material_mismatch AND (material1 = 'CS' AND material2 LIKE '%SS%')"
      severity: critical
      reason: "Carbon/Stainless mismatch could indicate corrosion risk"
    # Critical: Pressure boundary
    - condition: "size_mismatch AND abs(size_diff) > 2"
      severity: critical
      reason: "Major size discrepancy on same line"
    # High: NDE requirements
    - condition: "weld_inconsistency AND nde_required"
      severity: high
    # Medium: Default for material
    - condition: "material_mismatch"
      severity: medium
    # Low: Minor spec differences
    - condition: "spec_class_mismatch"
      severity: low

# =============================================================================
# REPORTING
# =============================================================================

reporting:
  # Output formats
  formats:
    - markdown

  # Report sections
  sections:
    - summary
    - critical_conflicts
    - material_conflicts
    - cross_discipline
    - revision_changes
    - extraction_quality

  # Grouping
  group_by: discipline

  # Include in report
  include:
    unresolved_only: true
    confidence_below: 0.8
    show_resolution_suggestions: true

# =============================================================================
# PROCESSING
# =============================================================================

processing:
  # Batch sizes
  batch_size: 10                 # Sheets per extraction batch

  # Priority rules (lower = higher priority)
  priority:
    new_revision: 1              # Always process new revisions first
    unprocessed_p&id: 2          # P&IDs drive everything else
    unprocessed_iso: 3           # Isometrics have weld details
    unprocessed_other: 5
    reprocess_low_confidence: 7

  # Automatic actions
  auto:
    supersede_old_revisions: true
    archive_superseded: false    # Keep in place with -SUPERSEDED suffix
    queue_related_recheck: true  # Re-cross-check when related sheets change

# =============================================================================
# INTAKE
# =============================================================================

intake:
  # Automation options
  auto_extract: false     # Set true to auto-run /go after intake (can override with --extract flag)
  auto_embed: true        # Always embed extracted data to vector DB (in /go)

  # File naming expectations
  # Pattern: ProjectNumber_DrawingNumber_Rev_SheetX.pdf
  # Example: 07600_P-101_B_Sheet1.pdf
  file_patterns:
    - "^(\\d{5})[-_]([A-Z]+-\\d+)[-_]([A-Z0-9]+).*\\.pdf$"
    - "^([A-Z]+-\\d+)[-_]([A-Z0-9]+).*\\.pdf$"  # Without project number

  # Fallback: read title block if filename doesn't match
  read_title_block_always: true

  # Actions on conflict
  on_ambiguous: move_to_needs_review
  on_no_match: move_to_needs_review

  # Revision handling
  revision_suffixes:
    superseded: "-SUPERSEDED"
    conflict: "-CONFLICT"

# =============================================================================
# SPEC INTAKE (Specification Documents)
# =============================================================================

spec_intake:
  # Now uses unified inbox
  inbox: "D:/Inbox"
  needs_review: "D:/Inbox/NEEDS-REVIEW"

  # Project number detection from PDF pages
  project_detection:
    # Where to look for project number on page
    search_region: "bottom-left"       # bottom-left, bottom-center, title-block
    search_height_percent: 15          # Bottom 15% of page
    search_width_percent: 50           # Left 50% of page

    # Patterns to match (in order of priority)
    patterns:
      - "Project[:\\s]*([A-Z0-9-]{4,10})"
      - "Job\\s*(?:No\\.?|#)?[:\\s]*([A-Z0-9-]{4,10})"
      - "\\b(\\d{5})\\b"               # 5-digit number (like 07308)

  # Auto-create project if not found
  auto_create_project: false           # Require manual confirmation

  # Master spec comparison settings
  master_spec:
    auto_update: true                  # Update master on each import
    min_projects_for_baseline: 1       # How many projects before item is "baseline"
    variation_alert_threshold: 0.7     # Alert if consistency < 70%

  # Spec type classification (keywords in title)
  spec_types:
    piping: ["Piping", "Pipe", "Line Class"]
    valve: ["Valve"]
    flange: ["Flange"]
    fitting: ["Fitting"]
    instrument: ["Instrument", "I&C", "Control"]
    insulation: ["Insulation", "Heat Trace"]
    paint: ["Paint", "Coating", "Surface"]
    structural: ["Structural", "Steel"]
    general: ["General", "Standard"]

  # Item key normalization
  material_abbreviations:
    "carbon steel": "cs"
    "stainless steel": "ss"
    "stainless steel 304": "ss304"
    "stainless steel 316": "ss316"
    "stainless steel 316l": "ss316l"
    "alloy 20": "al20"
    "inconel": "inconel"
    "monel": "monel"
    "titanium": "ti"
    "copper": "cu"
    "aluminum": "al"
    "pvc": "pvc"
    "cpvc": "cpvc"
    "hdpe": "hdpe"
    "frp": "frp"
    "grp": "grp"

  # Variation significance rules
  variation_significance:
    critical:
      - material_class_change          # CS to SS, etc.
      - pressure_rating_difference_gt_1_class
      - test_pressure_difference_gt_20_percent
    high:
      - schedule_change
      - end_connection_change
      - nde_requirement_change
    medium:
      - material_grade_change          # A106 to A53
      - gasket_type_change
    low:
      - bolt_grade_change
      - minor_dimensional_difference

# =============================================================================
# QUALITY MANAGEMENT DOCUMENT PREFIXES
# Configurable - change these to match your naming conventions
# =============================================================================

qm_prefixes:
  SP: "Standard Operating Procedure"
  WI: "Work Instruction"
  TP: "Template"
  FM: "Form"
  PL: "Policy"
  RC: "Record"

# =============================================================================
# REFERENCE EXTRACTION (Parallel Processing)
# =============================================================================
# Settings for extracting content from large reference standard PDFs
# Uses multi-agent parallel extraction for standards above threshold

reference_extraction:
  # Standards with more pages than this use parallel extraction
  parallel_threshold_pages: 50

  # Maximum extractor agents running concurrently
  max_concurrent_extractors: 4

  # Pages of overlap between sections (for boundary clause capture)
  section_overlap_pages: 2

  # Target section size when splitting (may vary based on TOC structure)
  target_section_pages: 50

  # Model assignments for each extraction phase
  models:
    splitting: haiku      # TOC parsing, PDF splitting - fast/cheap
    extraction: sonnet    # Content extraction - balanced quality/speed
    merging: sonnet       # Deduplication, hierarchy building
    validation: opus      # Quality assurance, accuracy sampling

  # Confidence thresholds
  confidence:
    high: 0.9             # Above this = high confidence extraction
    medium: 0.7           # 0.7-0.9 = medium confidence
    low: 0.7              # Below this = flagged for review

  # Validation thresholds
  validation:
    completeness_pass: 0.95     # TOC coverage for pass
    completeness_warn: 0.80     # Below this = warning
    accuracy_pass: 0.90         # Sampling accuracy for pass
    accuracy_warn: 0.80         # Below this = warning
    sample_rate: 0.10           # 10% of clauses sampled for validation

  # Retry settings for failed sections
  retry:
    max_attempts: 3
    backoff_seconds: 30

  # File organization
  paths:
    references_root: "D:/Quality Documents/References"
    section_subdir: "sections"
    manifest_file: "MANIFEST.json"
    validation_report: "VALIDATION.md"
    extraction_log: "extraction-log.txt"
