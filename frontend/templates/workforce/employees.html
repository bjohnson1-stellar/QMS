{% extends "base.html" %}

{% block title %}Workforce - QMS{% endblock %}

{% block content %}
<div class="page-header" style="display:flex;justify-content:space-between;align-items:center;">
    <div>
        <h1>Workforce</h1>
        <p class="subtitle">Employee directory and manager assignments</p>
    </div>
    <button onclick="openEmployeeModal()">+ Add Employee</button>
</div>

<!-- Stats Cards -->
<div class="stats-grid" id="statsGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;">
    <div class="stat-card">
        <div class="stat-value" id="statActive">-</div>
        <div class="stat-label">Active Employees</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statTopRole">-</div>
        <div class="stat-label" id="statTopRoleLabel">Most Common Role</div>
    </div>
    <div class="stat-card" id="statUnassignedCard">
        <div class="stat-value" id="statUnassigned">-</div>
        <div class="stat-label">No Manager Assigned</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statDepts">-</div>
        <div class="stat-label">Departments</div>
    </div>
</div>

<!-- Employee Modal -->
<div id="employeeModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="empFormTitle" style="margin:0;border:none;padding:0;">Add New Employee</h2>
            <button class="modal-close" onclick="closeEmployeeModal()">&times;</button>
        </div>
        <div class="success-message" id="empSuccessMessage"></div>
        <div class="error-message" id="empErrorMessage"></div>
        <form id="employeeForm">
            <div class="modal-form-grid">
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" id="empFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" id="empLastName" required>
                </div>
                <div class="form-group">
                    <label>Position</label>
                    <input type="text" id="empPosition" placeholder="e.g. Pipefitter">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="empRole">
                        <option value="">Select Role</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <select id="empDepartment">
                        <option value="">Select Department</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Job</label>
                    <select id="empJob">
                        <option value="">Select Job</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Supervisor</label>
                    <select id="empSupervisor">
                        <option value="">No Supervisor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="empStatus">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="on_leave">On Leave</option>
                        <option value="terminated">Terminated</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="empEmail" placeholder="name@company.com">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="empPhone" placeholder="555-123-4567">
                </div>
                <div class="form-group" style="grid-column:1/-1;">
                    <label>Notes</label>
                    <textarea id="empNotes" rows="2"></textarea>
                </div>
            </div>
            <div style="margin-top:20px;padding-top:15px;border-top:1px solid var(--color-border-light);display:flex;gap:10px;">
                <button type="submit" id="empSubmitBtn">Add Employee</button>
                <button type="button" class="secondary" onclick="closeEmployeeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="success-message" id="pageSuccessMessage"></div>
<div class="error-message" id="pageErrorMessage"></div>

<div class="card">
    <div class="filter-bar">
        <input type="text" id="searchFilter" placeholder="Search by name, number, position..." oninput="renderEmployees()">
        <select id="statusFilter" onchange="renderEmployees()">
            <option value="">Active Only</option>
            <option value="all">All Statuses</option>
            <option value="inactive">Inactive</option>
            <option value="on_leave">On Leave</option>
            <option value="terminated">Terminated</option>
        </select>
        <select id="roleFilter" onchange="renderEmployees()">
            <option value="">All Roles</option>
        </select>
        <select id="deptFilter" onchange="renderEmployees()">
            <option value="">All Departments</option>
        </select>
        <div class="view-toggle" style="margin-left:auto;display:flex;gap:0;">
            <button id="viewFlat" class="toggle-btn active" onclick="setViewMode('flat')">Flat</button>
            <button id="viewByJob" class="toggle-btn" onclick="setViewMode('job')">By Job</button>
        </div>
    </div>
    <div id="employeesTable"><div class="loading">Loading employees...</div></div>
</div>

<!-- Bulk Actions Toolbar -->
<div id="bulkToolbar" class="bulk-toolbar" style="display:none;">
    <span id="bulkCount" class="bulk-count">0 selected</span>
    <div class="bulk-actions">
        <select id="bulkManagerSelect" class="bulk-input">
            <option value="">Assign Manager...</option>
        </select>
        <button class="bulk-btn" onclick="bulkAssignManager()">Apply</button>
        <span class="bulk-sep">|</span>
        <select id="bulkRoleSelect" class="bulk-input">
            <option value="">Set Role...</option>
        </select>
        <button class="bulk-btn" onclick="bulkSetRole()">Apply</button>
        <span class="bulk-sep">|</span>
        <select id="bulkStatusSelect" class="bulk-input">
            <option value="">Set Status...</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="on_leave">On Leave</option>
            <option value="terminated">Terminated</option>
        </select>
        <button class="bulk-btn" onclick="bulkSetStatus()">Apply</button>
    </div>
    <button class="bulk-btn bulk-btn-clear" onclick="clearSelection()">&times; Clear</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API = '/workforce/api';
    let employees = [];
    let managers = [];
    let roles = [];
    let departments = [];
    let jobs = [];
    let currentEditId = null;
    let viewMode = 'flat';
    let selectedEmployees = new Set();

    // ── Data loading ───────────────────────────────────────────────────

    async function loadAll() {
        await Promise.all([
            loadEmployees(),
            loadManagers(),
            loadRoles(),
            loadDepartments(),
            loadJobs(),
            loadStats(),
        ]);
    }

    async function loadEmployees() {
        try {
            const res = await fetch(`${API}/employees?include_inactive=1`);
            employees = await res.json();
            renderEmployees();
        } catch (e) { showError('Failed to load employees'); }
    }

    async function loadManagers() {
        try {
            const res = await fetch(`${API}/employees/managers`);
            managers = await res.json();
            populateManagerDropdowns();
        } catch (e) { console.error('Failed to load managers', e); }
    }

    async function loadRoles() {
        try {
            const res = await fetch(`${API}/roles`);
            roles = await res.json();
            populateRoleDropdowns();
        } catch (e) { console.error('Failed to load roles', e); }
    }

    async function loadDepartments() {
        try {
            const res = await fetch(`${API}/departments`);
            departments = await res.json();
            populateDeptDropdowns();
        } catch (e) { console.error('Failed to load departments', e); }
    }

    async function loadJobs() {
        try {
            const res = await fetch(`${API}/jobs`);
            jobs = await res.json();
            populateJobDropdown();
        } catch (e) { console.error('Failed to load jobs', e); }
    }

    async function loadStats() {
        try {
            const res = await fetch(`${API}/employees/stats`);
            const stats = await res.json();
            document.getElementById('statActive').textContent = stats.total_active;
            document.getElementById('statDepts').textContent = stats.department_count;
            document.getElementById('statUnassigned').textContent = stats.unassigned_manager;
            const card = document.getElementById('statUnassignedCard');
            if (stats.unassigned_manager > 0) {
                card.style.borderLeft = '3px solid var(--color-warning)';
            } else {
                card.style.borderLeft = '';
            }
            // Most common role
            const topRole = Object.entries(stats.by_role || {}).sort((a,b) => b[1]-a[1])[0];
            if (topRole) {
                document.getElementById('statTopRole').textContent = topRole[1];
                document.getElementById('statTopRoleLabel').textContent = topRole[0];
            }
        } catch (e) { console.error('Failed to load stats', e); }
    }

    // ── Dropdown population ────────────────────────────────────────────

    function populateManagerDropdowns() {
        const selectors = ['empSupervisor', 'bulkManagerSelect'];
        selectors.forEach(id => {
            const sel = document.getElementById(id);
            const first = sel.options[0].outerHTML;
            sel.innerHTML = first;
            managers.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.last_name}, ${m.first_name}${m.employee_number ? ' (' + m.employee_number + ')' : ''}`;
                sel.appendChild(opt);
            });
        });
    }

    function populateRoleDropdowns() {
        const selectors = ['empRole', 'roleFilter', 'bulkRoleSelect'];
        selectors.forEach(id => {
            const sel = document.getElementById(id);
            const first = sel.options[0].outerHTML;
            sel.innerHTML = first;
            roles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.role_name;
                sel.appendChild(opt);
            });
        });
    }

    function populateDeptDropdowns() {
        const sel = document.getElementById('deptFilter');
        const first = sel.options[0].outerHTML;
        sel.innerHTML = first;
        departments.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.name;
            sel.appendChild(opt);
        });
        const empSel = document.getElementById('empDepartment');
        const empFirst = empSel.options[0].outerHTML;
        empSel.innerHTML = empFirst;
        departments.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = d.name;
            empSel.appendChild(opt);
        });
    }

    function populateJobDropdown() {
        const sel = document.getElementById('empJob');
        const first = sel.options[0].outerHTML;
        sel.innerHTML = first;
        jobs.forEach(j => {
            const opt = document.createElement('option');
            opt.value = j.id;
            opt.textContent = `${j.job_number} - ${j.project_name}`;
            sel.appendChild(opt);
        });
    }

    // ── Filtering ──────────────────────────────────────────────────────

    function getFilteredEmployees() {
        let filtered = [...employees];
        const search = (document.getElementById('searchFilter').value || '').toLowerCase();
        const statusVal = document.getElementById('statusFilter').value;
        const roleVal = document.getElementById('roleFilter').value;
        const deptVal = document.getElementById('deptFilter').value;

        // Status filter
        if (!statusVal) {
            filtered = filtered.filter(e => e.status === 'active');
        } else if (statusVal !== 'all') {
            filtered = filtered.filter(e => e.status === statusVal);
        }

        if (roleVal) {
            filtered = filtered.filter(e => e.role_id == roleVal);
        }
        if (deptVal) {
            filtered = filtered.filter(e => e.department_id == deptVal);
        }
        if (search) {
            filtered = filtered.filter(e =>
                (e.last_name && e.last_name.toLowerCase().includes(search)) ||
                (e.first_name && e.first_name.toLowerCase().includes(search)) ||
                (e.employee_number && e.employee_number.toLowerCase().includes(search)) ||
                (e.position && e.position.toLowerCase().includes(search)) ||
                (e.email && e.email.toLowerCase().includes(search)) ||
                (e.supervisor_name && e.supervisor_name.toLowerCase().includes(search))
            );
        }
        return filtered;
    }

    // ── Rendering ──────────────────────────────────────────────────────

    function esc(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function statusBadge(status) {
        const cls = {active:'success', inactive:'secondary', on_leave:'warning', terminated:'danger'};
        return `<span class="badge badge-${cls[status] || 'secondary'}">${esc(status)}</span>`;
    }

    let expandedGroups = new Set();

    function toggleGroup(key) {
        if (expandedGroups.has(key)) expandedGroups.delete(key);
        else expandedGroups.add(key);
        renderEmployees();
    }

    function renderEmployees() {
        if (viewMode === 'job') return renderByJob();
        return renderFlat();
    }

    function renderFlat() {
        const container = document.getElementById('employeesTable');
        const filtered = getFilteredEmployees();

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">No employees found matching filters.</div>';
            return;
        }

        let html = '<table><thead><tr>';
        html += '<th style="width:40px;"><input type="checkbox" id="selectAllCb" onchange="toggleSelectAll(this)" title="Select all"></th>';
        html += '<th>Employee #</th><th>Name</th><th>Position</th><th>Role</th>';
        html += '<th>Manager</th><th>Job / Project</th><th>Status</th>';
        html += '</tr></thead><tbody>';

        filtered.forEach(e => {
            html += `<tr class="job-row">`;
            html += `<td onclick="event.stopPropagation()"><input type="checkbox" class="emp-select-cb" data-emp-id="${esc(e.id)}" ${selectedEmployees.has(e.id) ? 'checked' : ''} onchange="toggleEmpSelect('${esc(e.id)}',this)"></td>`;
            html += `<td><span class="job-code">${esc(e.employee_number || e.subcontractor_number || '-')}</span></td>`;
            html += `<td><a href="#" onclick="editEmployee('${esc(e.id)}');return false;" style="font-weight:600;color:var(--color-primary);">${esc(e.last_name)}, ${esc(e.first_name)}</a></td>`;
            html += `<td>${esc(e.position || '')}</td>`;
            // Inline role dropdown
            html += `<td>`;
            html += `<select class="stage-select" onchange="quickSetRole('${esc(e.id)}',this.value)" onclick="event.stopPropagation()">`;
            html += `<option value="">—</option>`;
            roles.forEach(r => {
                html += `<option value="${r.id}"${e.role_id == r.id ? ' selected' : ''}>${esc(r.role_name)}</option>`;
            });
            html += `</select></td>`;
            // Manager cell (inline dropdown)
            html += `<td>`;
            html += `<select class="stage-select" onchange="quickSetSupervisor('${esc(e.id)}',this.value)" onclick="event.stopPropagation()">`;
            html += `<option value="">Unassigned</option>`;
            managers.forEach(m => {
                const selected = e.supervisor_id === m.id ? ' selected' : '';
                html += `<option value="${esc(m.id)}"${selected}>${esc(m.last_name)}, ${esc(m.first_name)}</option>`;
            });
            html += `</select></td>`;
            // Job / Project
            html += `<td>`;
            if (e.job_number) {
                html += `<span class="job-code">${esc(e.job_number)}</span>`;
                if (e.project_name) html += ` <span style="color:var(--color-text-muted)">${esc(e.project_name)}</span>`;
            } else {
                html += `<span style="color:var(--color-text-muted)">—</span>`;
            }
            html += `</td>`;
            html += `<td>${statusBadge(e.status)}</td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        html += `<div style="padding:8px 12px;font-size:12px;color:var(--color-text-muted);">${filtered.length} employee${filtered.length !== 1 ? 's' : ''}</div>`;
        container.innerHTML = html;
        updateBulkToolbar();
    }

    function renderByJob() {
        const container = document.getElementById('employeesTable');
        const filtered = getFilteredEmployees();

        // Group by job_id
        const jobMap = {};
        filtered.forEach(e => {
            const key = e.job_id || 'none';
            if (!jobMap[key]) {
                jobMap[key] = {
                    job_number: e.job_number || null,
                    project_name: e.project_name || null,
                    employees: []
                };
            }
            jobMap[key].employees.push(e);
        });

        const groups = Object.entries(jobMap).sort((a, b) => {
            if (a[0] === 'none') return 1;
            if (b[0] === 'none') return -1;
            return (a[1].job_number || '').localeCompare(b[1].job_number || '');
        });

        if (groups.length === 0) {
            container.innerHTML = '<div class="empty-state">No employees found matching filters.</div>';
            return;
        }

        let html = '<table><thead><tr>';
        html += '<th style="width:40px;"><input type="checkbox" id="selectAllCb" onchange="toggleSelectAll(this)" title="Select all"></th>';
        html += '<th>Employee #</th><th>Name</th><th>Position</th><th>Role</th>';
        html += '<th>Manager</th><th>Status</th>';
        html += '</tr></thead><tbody>';

        groups.forEach(([key, group]) => {
            const gKey = 'job-' + key;
            const expanded = expandedGroups.has(gKey);
            const label = group.job_number
                ? `${group.job_number} - ${group.project_name || 'Unknown Project'}`
                : 'No Job Assigned';
            const count = group.employees.length;

            html += `<tr class="project-header" onclick="toggleGroup('${gKey}')">`;
            html += `<td></td>`;
            html += `<td colspan="4">`;
            html += `<div class="project-toggle">`;
            html += `<span class="toggle-icon ${expanded ? 'expanded' : ''}">\u25B6</span>`;
            html += `<span class="project-name">${esc(label)}</span>`;
            html += `</div></td>`;
            html += `<td><span class="job-count-badge">${count}</span></td>`;
            html += `<td></td>`;
            html += `</tr>`;

            if (expanded) {
                group.employees.forEach(e => {
                    html += `<tr class="job-row">`;
                    html += `<td onclick="event.stopPropagation()"><input type="checkbox" class="emp-select-cb" data-emp-id="${esc(e.id)}" ${selectedEmployees.has(e.id) ? 'checked' : ''} onchange="toggleEmpSelect('${esc(e.id)}',this)"></td>`;
                    html += `<td><span class="job-code">${esc(e.employee_number || e.subcontractor_number || '-')}</span></td>`;
                    html += `<td><a href="#" onclick="editEmployee('${esc(e.id)}');return false;" style="font-weight:600;color:var(--color-primary);">${esc(e.last_name)}, ${esc(e.first_name)}</a></td>`;
                    html += `<td>${esc(e.position || '')}</td>`;
                    html += `<td>`;
                    html += `<select class="stage-select" onchange="quickSetRole('${esc(e.id)}',this.value)" onclick="event.stopPropagation()">`;
                    html += `<option value="">—</option>`;
                    roles.forEach(r => {
                        html += `<option value="${r.id}"${e.role_id == r.id ? ' selected' : ''}>${esc(r.role_name)}</option>`;
                    });
                    html += `</select></td>`;
                    html += `<td>`;
                    html += `<select class="stage-select" onchange="quickSetSupervisor('${esc(e.id)}',this.value)" onclick="event.stopPropagation()">`;
                    html += `<option value="">Unassigned</option>`;
                    managers.forEach(m => {
                        const selected = e.supervisor_id === m.id ? ' selected' : '';
                        html += `<option value="${esc(m.id)}"${selected}>${esc(m.last_name)}, ${esc(m.first_name)}</option>`;
                    });
                    html += `</select></td>`;
                    html += `<td>${statusBadge(e.status)}</td>`;
                    html += `</tr>`;
                });
            }
        });

        html += '</tbody></table>';
        html += `<div style="padding:8px 12px;font-size:12px;color:var(--color-text-muted);">${filtered.length} employee${filtered.length !== 1 ? 's' : ''}</div>`;
        container.innerHTML = html;
        updateBulkToolbar();
    }

    // ── View toggle ────────────────────────────────────────────────────

    function setViewMode(mode) {
        viewMode = mode;
        expandedGroups.clear();
        document.getElementById('viewFlat').classList.toggle('active', mode === 'flat');
        document.getElementById('viewByJob').classList.toggle('active', mode === 'job');
        renderEmployees();
    }

    // ── Selection & Bulk ───────────────────────────────────────────────

    function toggleEmpSelect(empId, cb) {
        if (cb.checked) selectedEmployees.add(empId);
        else selectedEmployees.delete(empId);
        updateBulkToolbar();
    }

    function toggleSelectAll(masterCb) {
        document.querySelectorAll('.emp-select-cb').forEach(cb => {
            const id = cb.dataset.empId;
            cb.checked = masterCb.checked;
            if (masterCb.checked) selectedEmployees.add(id);
            else selectedEmployees.delete(id);
        });
        updateBulkToolbar();
    }

    function clearSelection() {
        selectedEmployees.clear();
        document.querySelectorAll('.emp-select-cb').forEach(cb => cb.checked = false);
        const master = document.getElementById('selectAllCb');
        if (master) master.checked = false;
        updateBulkToolbar();
    }

    function updateBulkToolbar() {
        const toolbar = document.getElementById('bulkToolbar');
        const count = selectedEmployees.size;
        if (count > 0) {
            toolbar.style.display = 'flex';
            document.getElementById('bulkCount').textContent = `${count} selected`;
        } else {
            toolbar.style.display = 'none';
        }
    }

    async function bulkAssignManager() {
        const val = document.getElementById('bulkManagerSelect').value;
        if (!val) return;
        await doBulk('assign_manager', val);
    }

    async function bulkSetRole() {
        const val = document.getElementById('bulkRoleSelect').value;
        if (!val) return;
        await doBulk('set_role', parseInt(val));
    }

    async function bulkSetStatus() {
        const val = document.getElementById('bulkStatusSelect').value;
        if (!val) return;
        await doBulk('set_status', val);
    }

    async function doBulk(action, value) {
        const ids = Array.from(selectedEmployees);
        if (ids.length === 0) return;
        try {
            const res = await fetch(`${API}/employees/bulk`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ids, action, value})
            });
            const result = await res.json();
            if (res.ok) {
                showSuccess(`Updated ${result.updated} employee(s)`);
                selectedEmployees.clear();
                loadEmployees();
                loadManagers();
                loadStats();
            } else {
                showError(result.error || 'Bulk action failed');
            }
        } catch (e) { showError('Bulk action failed'); }
    }

    // ── Inline edits ───────────────────────────────────────────────────

    async function quickSetSupervisor(empId, supId) {
        try {
            const res = await fetch(`${API}/employees/${empId}/supervisor`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({supervisor_id: supId || null})
            });
            if (res.ok) {
                const emp = employees.find(e => e.id === empId);
                if (emp) {
                    emp.supervisor_id = supId || null;
                    const mgr = managers.find(m => m.id === supId);
                    emp.supervisor_name = mgr ? `${mgr.first_name} ${mgr.last_name}` : null;
                }
                loadStats();
            }
        } catch (e) { showError('Failed to update supervisor'); }
    }

    async function quickSetRole(empId, roleId) {
        try {
            const res = await fetch(`${API}/employees/${empId}/role`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role_id: roleId ? parseInt(roleId) : null})
            });
            if (res.ok) {
                const emp = employees.find(e => e.id === empId);
                if (emp) {
                    emp.role_id = roleId ? parseInt(roleId) : null;
                    const role = roles.find(r => r.id == roleId);
                    emp.role_name = role ? role.role_name : null;
                }
                loadStats();
            }
        } catch (e) { showError('Failed to update role'); }
    }

    // ── Modal (Create / Edit) ──────────────────────────────────────────

    function openEmployeeModal() {
        resetForm();
        document.getElementById('employeeModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeEmployeeModal() {
        document.getElementById('employeeModal').style.display = 'none';
        document.body.style.overflow = '';
        resetForm();
    }

    function resetForm() {
        document.getElementById('employeeForm').reset();
        currentEditId = null;
        document.getElementById('empSubmitBtn').textContent = 'Add Employee';
        document.getElementById('empFormTitle').textContent = 'Add New Employee';
    }

    function editEmployee(empId) {
        const emp = employees.find(e => e.id === empId);
        if (!emp) return;
        document.getElementById('empFirstName').value = emp.first_name || '';
        document.getElementById('empLastName').value = emp.last_name || '';
        document.getElementById('empPosition').value = emp.position || '';
        document.getElementById('empRole').value = emp.role_id || '';
        document.getElementById('empDepartment').value = emp.department_id || '';
        document.getElementById('empJob').value = emp.job_id || '';
        document.getElementById('empSupervisor').value = emp.supervisor_id || '';
        document.getElementById('empStatus').value = emp.status || 'active';
        document.getElementById('empEmail').value = emp.email || '';
        document.getElementById('empPhone').value = emp.phone || '';
        document.getElementById('empNotes').value = emp.notes || '';
        currentEditId = empId;
        document.getElementById('empSubmitBtn').textContent = 'Update Employee';
        document.getElementById('empFormTitle').textContent = 'Edit Employee';
        document.getElementById('employeeModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    document.getElementById('employeeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = {
            first_name: document.getElementById('empFirstName').value,
            last_name: document.getElementById('empLastName').value,
            position: document.getElementById('empPosition').value || null,
            role_id: document.getElementById('empRole').value ? parseInt(document.getElementById('empRole').value) : null,
            department_id: document.getElementById('empDepartment').value ? parseInt(document.getElementById('empDepartment').value) : null,
            job_id: document.getElementById('empJob').value ? parseInt(document.getElementById('empJob').value) : null,
            supervisor_id: document.getElementById('empSupervisor').value || null,
            status: document.getElementById('empStatus').value,
            email: document.getElementById('empEmail').value || null,
            phone: document.getElementById('empPhone').value || null,
            notes: document.getElementById('empNotes').value || null,
        };

        try {
            const url = currentEditId ? `${API}/employees/${currentEditId}` : `${API}/employees`;
            const method = currentEditId ? 'PUT' : 'POST';
            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                closeEmployeeModal();
                showSuccess(currentEditId ? 'Employee updated' : 'Employee added');
                loadEmployees();
                loadManagers();
                loadStats();
            } else {
                showModalError(result.error || 'Failed to save');
            }
        } catch (err) {
            showModalError('Failed to save employee');
        }
    });

    // ── Keyboard / UI helpers ──────────────────────────────────────────

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('employeeModal').style.display === 'flex') {
            closeEmployeeModal();
        }
    });

    document.getElementById('employeeModal').addEventListener('click', function(e) {
        if (e.target === this) closeEmployeeModal();
    });

    function showSuccess(msg) {
        const el = document.getElementById('pageSuccessMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function showError(msg) {
        const el = document.getElementById('pageErrorMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    function showModalError(msg) {
        const el = document.getElementById('empErrorMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    // ── Init ───────────────────────────────────────────────────────────
    loadAll();
</script>
{% endblock %}
