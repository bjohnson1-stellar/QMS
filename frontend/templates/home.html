{% extends "base.html" %}

{% block title %}Home - {{ theme.app_name }}{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="landing-hero">
    <div class="landing-hero-text">
        <h1>{{ theme.app_name }}</h1>
        <p class="landing-hero-tagline">{{ theme.app_tagline }}</p>
        <p class="landing-hero-desc">Centralized quality management, welding programs, and document control.</p>
    </div>
    <div class="landing-hero-mascot">
        <img src="{{ url_for('static', filename='mascot.svg') }}" alt="Navigator Penguin" width="220" height="220">
    </div>
</div>

<!-- Dashboard Stats -->
<div class="stats-grid" style="margin-bottom:24px;">
    <div class="stat-card">
        <div class="stat-value">{{ stats.get('active_projects', 0) }}</div>
        <div class="stat-label">Active Projects</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.get('open_alerts', 0) }}</div>
        <div class="stat-label">Open Alerts</div>
    </div>
    {% if 'pipeline' in accessible_modules %}
    <div class="stat-card">
        <div class="stat-value">{{ stats.get('pending_drawings', 0) }}</div>
        <div class="stat-label">Pending Drawings</div>
    </div>
    {% endif %}
    {% if 'welding' in accessible_modules %}
    <div class="stat-card">
        <div class="stat-value">{{ stats.get('active_welders', 0) }}</div>
        <div class="stat-label">Active Welders</div>
    </div>
    {% endif %}
    {% if stats.get('employees') and 'workforce' in accessible_modules %}
    <div class="stat-card">
        <div class="stat-value">{{ stats.employees }}</div>
        <div class="stat-label">Employees</div>
    </div>
    {% endif %}
</div>

<!-- Two-column: Recent Projects + Activity Feed -->
<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
    {% if recent_projects %}
    <div class="card">
        <h2>Recent Projects</h2>
        <table>
            <thead>
                <tr><th>Number</th><th>Name</th><th>Stage</th></tr>
            </thead>
            <tbody>
            {% for p in recent_projects %}
                <tr>
                    <td><a href="{{ url_for('projects.project_detail', project_number=p.number) }}" style="color:var(--color-primary); text-decoration:none; font-weight:500;">{{ p.number }}</a></td>
                    <td>{{ p.name }}</td>
                    <td><span style="font-size:12px; color:var(--color-text-muted);">{{ p.stage }}</span></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if activity %}
    <div class="card">
        <h2>Recent Activity</h2>
        {% for a in activity %}
        <div style="padding:6px 0; border-bottom:1px solid var(--color-border-light); font-size:13px; display:flex; justify-content:space-between; align-items:baseline;">
            <div>
                {% if a.type == 'drawing' %}
                    <span style="color:var(--color-primary); font-weight:500;">Drawing</span>
                {% elif a.type == 'weld' %}
                    <span style="color:var(--color-warning); font-weight:500;">Weld</span>
                {% else %}
                    <span style="font-weight:500;">{{ a.type }}</span>
                {% endif %}
                <span style="color:var(--color-text-secondary); margin-left:6px;">{{ a.detail or '' }}</span>
                {% if a.project %}
                <a href="{{ url_for('projects.project_detail', project_number=a.project) }}" style="color:var(--color-text-muted); text-decoration:none; margin-left:6px; font-size:12px;">{{ a.project }}</a>
                {% endif %}
            </div>
            <span style="font-size:11px; color:var(--color-text-muted); white-space:nowrap;">{{ (a.ts or '')[:10] }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Module Cards -->
<div class="landing-section">
    <h2 class="landing-section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Quick Access
    </h2>
    <div class="landing-modules">
        {% set module_icons = {
            'projects': '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            'welding': '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
            'pipeline': '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>',
            'automation': '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>',
            'workforce': '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'qualitydocs': '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>'
        } %}
        {% set module_descs = {
            'projects': 'Budgets, allocations, and project tracking',
            'welding': 'WPS, WPQ, welder qualifications',
            'pipeline': 'Document intake and routing',
            'automation': 'Power Automate card preview',
            'workforce': 'Employee directory and management',
            'qualitydocs': 'Quality manual and procedures'
        } %}
        {% for mod_key, mod_info in web_modules.items() %}
        {% if mod_key in accessible_modules %}
        <a href="{{ url_for(mod_info.default_endpoint) }}" class="landing-module-card">
            <div class="landing-module-icon">{{ module_icons.get(mod_key, '') | safe }}</div>
            <div class="landing-module-label">{{ mod_info.label }}</div>
            <div class="landing-module-desc">{{ module_descs.get(mod_key, '') }}</div>
        </a>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- The Observatory — Blog Section -->
<div class="landing-section">
    <h2 class="landing-section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/><line x1="14.83" y1="9.17" x2="19.07" y2="4.93"/><line x1="4.93" y1="19.07" x2="9.17" y2="14.83"/></svg>
        The Observatory
        <span class="landing-section-subtitle">Notes from the Observatory</span>
    </h2>

    {% if posts %}
    <div class="landing-blog-grid">
        {% for post in posts %}
        <a href="{{ url_for('blog.blog_detail', slug=post.slug) }}" class="blog-card">
            <div class="blog-card-title">{{ post.title }}</div>
            <div class="blog-card-excerpt">{{ post.excerpt or post.content_md[:120] }}{% if post.content_md|length > 120 and not post.excerpt %}...{% endif %}</div>
            <div class="blog-card-meta">
                <span>{{ post.author_name or 'Admin' }}</span>
                <span class="blog-card-date">{{ post.created_at[:10] }}</span>
            </div>
        </a>
        {% endfor %}
    </div>
    <div style="margin-top:16px;">
        <a href="{{ url_for('blog.blog_list') }}" class="landing-view-all">View all observations &rarr;</a>
    </div>
    {% else %}
    <div class="landing-blog-empty">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/></svg>
        <p>The Observatory is quiet — first observation coming soon.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
