{% extends "base.html" %}

{% block title %}Welders - QMS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welders</h1>
    <p class="subtitle">Active welder roster and qualification summary</p>
</div>

<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Total Welders</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statActive">-</div>
        <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="statQualified">-</div>
        <div class="stat-label">With Active WPQs</div>
    </div>
    <div class="stat-card" id="statExpiringCard">
        <div class="stat-value" id="statExpiring">-</div>
        <div class="stat-label">Expiring in 30 Days</div>
    </div>
</div>

<div class="card">
    <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="Search by name or stamp..." onkeyup="filterTable()" style="min-width:250px;">
        <select id="statusFilter" onchange="filterTable()">
            <option value="">All Statuses</option>
            <option value="active" selected>Active</option>
            <option value="inactive">Inactive</option>
            <option value="terminated">Terminated</option>
            <option value="archived">Archived</option>
        </select>
    </div>

    <div id="tableContainer"><div class="loading">Loading...</div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allData = [];

async function loadWelders() {
    const container = document.getElementById('tableContainer');
    try {
        const res = await fetch('/welding/api/welders');
        allData = await res.json();
        updateStats();
        filterTable();
    } catch (err) {
        container.innerHTML = '<div class="empty-state">Failed to load welders.</div>';
    }
}

function updateStats() {
    const active = allData.filter(r => r.status === 'active');
    const withWpqs = active.filter(r => r.active_wpqs > 0);
    const now = new Date();
    const in30 = new Date(now.getTime() + 30 * 86400000);
    const expiring = active.filter(r => {
        if (!r.next_expiration) return false;
        const d = new Date(r.next_expiration);
        return d >= now && d <= in30;
    });

    const nonArchived = allData.filter(r => r.status !== 'archived');
    document.getElementById('statTotal').textContent = nonArchived.length;
    document.getElementById('statActive').textContent = active.length;
    document.getElementById('statQualified').textContent = withWpqs.length;
    document.getElementById('statExpiring').textContent = expiring.length;

    const card = document.getElementById('statExpiringCard');
    if (expiring.length > 0) {
        card.style.borderLeft = '3px solid var(--color-warning)';
        document.getElementById('statExpiring').style.color = 'var(--color-warning)';
    }
}

function filterTable() {
    const container = document.getElementById('tableContainer');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;

    let filtered = allData;
    if (statusFilter) {
        filtered = filtered.filter(r => (r.status || '') === statusFilter);
    }
    if (search) {
        filtered = filtered.filter(r =>
            (r.name || '').toLowerCase().includes(search) ||
            (r.stamp || '').toLowerCase().includes(search) ||
            (r.department || '').toLowerCase().includes(search)
        );
    }

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No welders found.</div>';
        return;
    }

    let html = '<table><thead><tr>';
    html += '<th>Name</th><th>Stamp</th><th>Department</th>';
    html += '<th>Active WPQs</th><th>Active BPQRs</th>';
    html += '<th>Next Expiration</th><th>Status</th>';
    html += '</tr></thead><tbody>';

    filtered.forEach(r => {
        const link = r.stamp ? `/welding/welder/${r.stamp}` : '#';
        const expClass = isExpiringSoon(r.next_expiration) ? ' style="color:var(--color-warning);font-weight:600;"' : '';
        html += `<tr class="clickable" onclick="window.location='${link}'">`;
        html += `<td><strong>${r.name || '-'}</strong></td>`;
        html += `<td><span style="font-family:var(--font-mono);color:var(--color-primary);font-weight:600;">${r.stamp || '-'}</span></td>`;
        html += `<td>${r.department || '-'}</td>`;
        html += `<td>${r.active_wpqs}</td>`;
        html += `<td>${r.active_bpqrs}</td>`;
        html += `<td${expClass}>${r.next_expiration || '-'}</td>`;
        html += `<td><span class="status-badge status-${r.status || 'pending'}">${r.status || '-'}</span></td>`;
        html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function isExpiringSoon(dateStr) {
    if (!dateStr) return false;
    const d = new Date(dateStr);
    const now = new Date();
    const in30 = new Date(now.getTime() + 30 * 86400000);
    return d >= now && d <= in30;
}

loadWelders();
</script>
{% endblock %}
