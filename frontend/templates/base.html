<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ theme.app_name }}{% endblock %}</title>

    {# Anti-FOUC: read dark mode preference before any paint #}
    <script>
        (function(){
            var mode = localStorage.getItem('qms-theme-mode');
            if (mode === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>

    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="{{ theme.fonts.google_fonts_url }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='brand-fonts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    {# Brand color overrides — injected from config.yaml, BETWEEN style.css and dark.css
       so dark.css [data-theme="dark"] selectors can override these :root values #}
    <style>
        :root {
            --color-primary: {{ theme.colors.primary }};
            --color-primary-hover: {{ theme.colors.primary_hover }};
            --color-primary-subtle: {{ theme.colors.primary_subtle }};
            --color-sidebar: {{ theme.colors.nav_bg }};
            --color-sidebar-hover: {{ theme.colors.nav_hover }};
            --color-sidebar-active: {{ theme.colors.nav_active }};
            --color-warning: {{ theme.colors.warning }};
            --font-heading: '{{ theme.fonts.heading }}', '{{ theme.fonts.heading_fallback }}', -apple-system, sans-serif;
            --font-body: '{{ theme.fonts.body }}', '{{ theme.fonts.body_fallback }}', -apple-system, sans-serif;
        }
    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='dark.css') }}">

    {% block extra_css %}{% endblock %}

    {# Detect active module from the current route (config-driven) — must be before <body> class ref #}
    {% set ns = namespace(module='home') %}
    {% if request.endpoint %}
        {% if request.endpoint == 'index' or (request.endpoint and request.endpoint.startswith('blog.')) %}
            {% set ns.module = 'home' %}
        {% elif request.endpoint.startswith('settings.') %}
            {% set ns.module = 'settings' %}
        {% else %}
            {% for mod_key in web_modules %}
                {% if request.endpoint.startswith(mod_key + '.') %}
                    {% set ns.module = mod_key %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
</head>
<body{% if ns.module == 'home' %} class="no-subnav"{% endif %}>

    <nav class="top-bar">
        <a href="/" class="top-bar-brand">
            <span class="top-bar-logo">{{ theme.app_name }}</span>
            <span class="top-bar-tagline">{{ theme.app_tagline }}</span>
        </a>
        <div class="top-bar-modules">
            {% set tab_icons = {
                'projects': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
                'welding': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
                'pipeline': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>',
                'automation': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>',
                'workforce': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                'qualitydocs': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
                'timetracker': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            } %}
            {% for mod_key, mod_info in web_modules.items() %}
            {% if mod_key in accessible_modules %}
            <a href="{{ url_for(mod_info.default_endpoint) }}"
               class="module-tab {{ 'active' if ns.module == mod_key }}">{{ tab_icons.get(mod_key, '') | safe }}{{ mod_info.label }}</a>
            {% endif %}
            {% endfor %}
        </div>
        <div class="top-bar-actions">
            <a href="{{ url_for('settings.settings_page') }}"
               class="settings-link {{ 'active' if ns.module == 'settings' }}" title="Settings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </a>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" aria-label="Toggle dark mode">
                <svg class="theme-icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                <svg class="theme-icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            </button>
            {% if current_user %}
            <div class="user-menu">
                <button class="user-avatar" onclick="toggleUserMenu()" title="{{ current_user.employee_name or current_user.display_name }}">
                    {{ (current_user.employee_name or current_user.display_name)[:2] | upper }}
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header">
                        <div class="user-dropdown-name">{{ current_user.employee_name or current_user.display_name }}</div>
                        <div class="user-dropdown-email">{{ current_user.email }}</div>
                        <div class="user-dropdown-role">
                            <span class="role-badge role-{{ current_user.role }}">{{ current_user.role }}</span>
                        </div>
                    </div>
                    <div class="user-dropdown-divider"></div>
                    <a href="{{ url_for('auth.change_password') }}" class="user-dropdown-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        Change password
                    </a>
                    <a href="{{ url_for('auth.logout') }}" class="user-dropdown-item">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        Sign out
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>

    <div class="sub-nav{% if ns.module == 'home' %} sub-nav-hidden{% endif %}">
        {% if ns.module == 'projects' %}
        <a href="{{ url_for('projects.dashboard') }}"
           class="{{ 'active' if request.endpoint == 'projects.dashboard' }}">Dashboard</a>
        <a href="{{ url_for('projects.projects_page') }}"
           class="{{ 'active' if request.endpoint == 'projects.projects_page' }}">Projects</a>
        {% elif ns.module == 'timetracker' %}
        <a href="{{ url_for('timetracker.projections_page') }}"
           class="{{ 'active' if request.endpoint == 'timetracker.projections_page' }}">Projections</a>
        <a href="{{ url_for('timetracker.transactions_page') }}"
           class="{{ 'active' if request.endpoint == 'timetracker.transactions_page' }}">Transactions</a>
        {% elif ns.module == 'settings' %}
        <a href="{{ url_for('settings.settings_page') }}"
           class="active">Settings</a>
        {% elif ns.module == 'welding' %}
        <a href="{{ url_for('welding.dashboard') }}"
           class="{{ 'active' if request.endpoint == 'welding.dashboard' }}">Dashboard</a>
        <a href="{{ url_for('welding.welders_list') }}"
           class="{{ 'active' if request.endpoint in ('welding.welders_list', 'welding.welder_profile') }}">Welders</a>
        <a href="{{ url_for('welding.forms_list') }}"
           class="{{ 'active' if request.endpoint and request.endpoint.startswith('welding.') and request.endpoint not in ('welding.dashboard', 'welding.welders_list', 'welding.welder_profile') }}">Forms</a>
        {% elif ns.module == 'pipeline' %}
        <a href="{{ url_for('pipeline.intake_dashboard') }}"
           class="{{ 'active' if request.endpoint == 'pipeline.intake_dashboard' }}">Document Intake</a>
        {% elif ns.module == 'automation' %}
        <a href="{{ url_for('automation.preview') }}"
           class="{{ 'active' if request.endpoint == 'automation.preview' }}">Card Preview</a>
        {% elif ns.module == 'workforce' %}
        <a href="{{ url_for('workforce.employees_page') }}"
           class="{{ 'active' if request.endpoint == 'workforce.employees_page' }}">Employees</a>
        {% if current_user and (current_user.role == 'admin' or
              current_user.modules.get('workforce') in ('admin', 'editor')) %}
        <a href="{{ url_for('workforce.import_page') }}"
           class="{{ 'active' if request.endpoint == 'workforce.import_page' }}">Import</a>
        {% endif %}
        {% elif ns.module == 'qualitydocs' %}
        <a href="{{ url_for('qualitydocs.manual') }}"
           class="{{ 'active' if request.endpoint == 'qualitydocs.manual' }}">Quality Manual</a>
        {% endif %}
    </div>

    <div class="main-content">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </div>

    <script>
        function toggleTheme() {
            var current = document.documentElement.getAttribute('data-theme');
            var next = current === 'dark' ? 'light' : 'dark';
            if (next === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem('qms-theme-mode', next);
        }

        function toggleUserMenu() {
            var dd = document.getElementById('userDropdown');
            if (dd) dd.classList.toggle('open');
        }

        document.addEventListener('click', function(e) {
            var menu = document.querySelector('.user-menu');
            var dd = document.getElementById('userDropdown');
            if (dd && menu && !menu.contains(e.target)) {
                dd.classList.remove('open');
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
