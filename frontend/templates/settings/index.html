{% extends "base.html" %}

{% block title %}Settings - {{ theme.app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
    <p class="subtitle">Centralized configuration for all QMS modules</p>
</div>

<div class="card" style="padding:0; overflow:hidden;">
    <div class="settings-layout">
        <!-- Left sidebar tabs -->
        <nav class="settings-nav">
            <div class="settings-nav-item active" data-tab="general">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                </span>
                General
            </div>
            <div class="settings-nav-item" data-tab="projects">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </span>
                Projects
            </div>
            <div class="settings-nav-item" data-tab="welding">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </span>
                Welding
            </div>
            <div class="settings-nav-item" data-tab="pipeline">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
                </span>
                Pipeline
            </div>
            <div class="settings-nav-item" data-tab="extraction">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                </span>
                Extraction
            </div>
            <div class="settings-nav-item" data-tab="branding">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><path d="M17.08 9.23a2.5 2.5 0 0 1 0 5.54"/><path d="M9.92 9.23a2.5 2.5 0 0 0 0 5.54"/><circle cx="13.5" cy="17.5" r="2.5"/></svg>
                </span>
                Branding
            </div>
            <div class="settings-nav-item" data-tab="integrations">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                </span>
                Integrations
            </div>
            <div class="settings-nav-item" data-tab="business-units">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                </span>
                Business Units
            </div>
            <div class="settings-nav-item" data-tab="users">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </span>
                Users & Access
            </div>
            <div class="settings-nav-item" data-tab="observatory">
                <span class="settings-nav-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/><line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/></svg>
                </span>
                The Observatory
            </div>
            {% if current_user and current_user.role == 'admin' %}
            <a href="/admin/system-map" style="display:block;margin-top:auto;padding:12px 16px;font-size:10px;color:var(--color-text-muted,#888);text-decoration:none;opacity:0.4;transition:opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.4'">sys v0.1.0</a>
            {% endif %}
        </nav>

        <!-- Right content panel -->
        <div class="settings-content">

            <!-- ═══════════════ GENERAL ═══════════════ -->
            <div class="settings-section active" id="tab-general">
                <h3>General</h3>
                <p class="section-desc">Company identity and application naming</p>
                <div class="settings-form-grid">
                    <div class="form-group full-width">
                        <label for="gen-companyName">Company Name</label>
                        <input type="text" id="gen-companyName">
                        <div class="help-text">Stored in database, used across reports and exports</div>
                    </div>
                    <div class="form-group">
                        <label for="gen-appName">Application Name</label>
                        <input type="text" id="gen-appName">
                    </div>
                    <div class="form-group">
                        <label for="gen-appTagline">Tagline</label>
                        <input type="text" id="gen-appTagline">
                    </div>
                </div>
                <div class="settings-save-row">
                    <button onclick="saveGeneral()">Save General</button>
                    <span class="settings-save-msg" id="msg-general"></span>
                </div>
            </div>

            <!-- ═══════════════ PROJECTS ═══════════════ -->
            <div class="settings-section" id="tab-projects">
                <h3>Projects & Budget</h3>
                <p class="section-desc">Default values for budget calculations and projections</p>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="proj-hourlyRate">Default Hourly Rate</label>
                        <div class="input-prefix">
                            <input type="number" id="proj-hourlyRate" step="0.01" min="0.01">
                        </div>
                        <div class="help-text">Used for projected costs</div>
                    </div>
                    <div class="form-group">
                        <label for="proj-hoursPerMonth">Working Hours / Month</label>
                        <input type="number" id="proj-hoursPerMonth" min="1" max="300">
                        <div class="help-text">Typical full-time: 176 (22 days x 8h)</div>
                    </div>
                    <div class="form-group">
                        <label for="proj-fiscalMonth">Fiscal Year Start</label>
                        <select id="proj-fiscalMonth">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="proj-gmpMultiplier">GMP Weight Multiplier</label>
                        <input type="number" id="proj-gmpMultiplier" step="0.1" min="1.0" max="5.0">
                        <div class="help-text">Applied to GMP projects (default: 1.5x)</div>
                    </div>
                    <div class="form-group">
                        <label for="proj-maxHoursWeek">Max Hours / Week</label>
                        <input type="number" id="proj-maxHoursWeek" step="0.5" min="1" max="80">
                        <div class="help-text">Distribution warning threshold</div>
                    </div>
                </div>
                <div class="settings-save-row">
                    <button onclick="saveProjects()">Save Projects</button>
                    <span class="settings-save-msg" id="msg-projects"></span>
                </div>
            </div>

            <!-- ═══════════════ WELDING ═══════════════ -->
            <div class="settings-section" id="tab-welding">
                <h3>Welding</h3>
                <p class="section-desc">Certification request defaults and qualification settings</p>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="weld-wcrPrefix">WCR Prefix</label>
                        <input type="text" id="weld-wcrPrefix">
                        <div class="help-text">Prefix for certification request IDs</div>
                    </div>
                    <div class="form-group">
                        <label for="weld-maxCoupons">Max Coupons / Request</label>
                        <input type="number" id="weld-maxCoupons" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label for="weld-wpqExpiry">WPQ Expiration (months)</label>
                        <input type="number" id="weld-wpqExpiry" min="1" max="60">
                        <div class="help-text">Default qualification expiry period</div>
                    </div>
                </div>
                <div class="settings-save-row">
                    <button onclick="saveConfigSection('welding.cert_requests', getWeldingData(), 'welding')">Save Welding</button>
                    <span class="settings-save-msg" id="msg-welding"></span>
                </div>
            </div>

            <!-- ═══════════════ PIPELINE ═══════════════ -->
            <div class="settings-section" id="tab-pipeline">
                <h3>Pipeline & Intake</h3>
                <p class="section-desc">Document intake behavior and processing batch settings</p>

                <h3 style="margin-top:20px; font-size:14px;">Intake</h3>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="intake-onAmbiguous">On Ambiguous Match</label>
                        <select id="intake-onAmbiguous">
                            <option value="move_to_needs_review">Move to NEEDS-REVIEW</option>
                            <option value="skip">Skip</option>
                            <option value="route_best_guess">Route Best Guess</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intake-onNoMatch">On No Match</label>
                        <select id="intake-onNoMatch">
                            <option value="move_to_needs_review">Move to NEEDS-REVIEW</option>
                            <option value="skip">Skip</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:12px; max-width:500px;">
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">Auto Extract</div>
                            <div class="settings-toggle-desc">Automatically extract data from routed documents</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="intake-autoExtract">
                            <div class="knobs"></div>
                            <div class="layer"></div>
                        </div>
                    </div>
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">Auto Embed</div>
                            <div class="settings-toggle-desc">Automatically generate vector embeddings</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="intake-autoEmbed">
                            <div class="knobs"></div>
                            <div class="layer"></div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top:24px; font-size:14px;">Processing</h3>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="proc-batchSize">Batch Size</label>
                        <input type="number" id="proc-batchSize" min="1" max="100">
                    </div>
                </div>
                <div style="margin-top:12px; max-width:500px;">
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">Supersede Old Revisions</div>
                            <div class="settings-toggle-desc">Automatically supersede when newer revision arrives</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="proc-supersede">
                            <div class="knobs"></div>
                            <div class="layer"></div>
                        </div>
                    </div>
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">Archive Superseded</div>
                            <div class="settings-toggle-desc">Move superseded files to archive folder</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="proc-archive">
                            <div class="knobs"></div>
                            <div class="layer"></div>
                        </div>
                    </div>
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">Queue Related Recheck</div>
                            <div class="settings-toggle-desc">Re-check related drawings on new revision</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="proc-recheck">
                            <div class="knobs"></div>
                            <div class="layer"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-save-row">
                    <button onclick="savePipeline()">Save Pipeline</button>
                    <span class="settings-save-msg" id="msg-pipeline"></span>
                </div>
            </div>

            <!-- ═══════════════ EXTRACTION ═══════════════ -->
            <div class="settings-section" id="tab-extraction">
                <h3>Extraction & QA</h3>
                <p class="section-desc">Confidence thresholds and conflict detection toggles</p>

                <h3 style="margin-top:4px; font-size:14px;">Confidence Thresholds</h3>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="ext-minConf">Minimum Confidence</label>
                        <input type="number" id="ext-minConf" step="0.05" min="0" max="1">
                        <div class="help-text">Below this, extraction is rejected (0-1)</div>
                    </div>
                    <div class="form-group">
                        <label for="ext-highConf">High Confidence</label>
                        <input type="number" id="ext-highConf" step="0.05" min="0" max="1">
                        <div class="help-text">Above this, auto-approved (0-1)</div>
                    </div>
                    <div class="form-group">
                        <label for="ext-shadowRate">Shadow Review Rate</label>
                        <input type="number" id="ext-shadowRate" step="0.01" min="0" max="1">
                        <div class="help-text">Fraction of extractions reviewed by Opus</div>
                    </div>
                </div>

                <h3 style="margin-top:24px; font-size:14px;">Conflict Detection Checks</h3>
                <div style="max-width:500px;">
                    <div class="settings-toggle-row">
                        <div><div class="settings-toggle-label">Material Mismatch</div></div>
                        <div class="toggle-switch"><input type="checkbox" id="chk-material"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                    <div class="settings-toggle-row">
                        <div><div class="settings-toggle-label">Size Mismatch</div></div>
                        <div class="toggle-switch"><input type="checkbox" id="chk-size"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                    <div class="settings-toggle-row">
                        <div><div class="settings-toggle-label">Tag Duplicate</div></div>
                        <div class="toggle-switch"><input type="checkbox" id="chk-tag"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                    <div class="settings-toggle-row">
                        <div><div class="settings-toggle-label">Missing Instrument</div></div>
                        <div class="toggle-switch"><input type="checkbox" id="chk-instrument"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                    <div class="settings-toggle-row">
                        <div><div class="settings-toggle-label">Weld Inconsistency</div></div>
                        <div class="toggle-switch"><input type="checkbox" id="chk-weld"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                    <div class="settings-toggle-row">
                        <div><div class="settings-toggle-label">Cross-Discipline</div></div>
                        <div class="toggle-switch"><input type="checkbox" id="chk-cross"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                </div>

                <div class="settings-save-row">
                    <button onclick="saveExtraction()">Save Extraction</button>
                    <span class="settings-save-msg" id="msg-extraction"></span>
                </div>
            </div>

            <!-- ═══════════════ BRANDING ═══════════════ -->
            <div class="settings-section" id="tab-branding">
                <h3>Branding & Theming</h3>
                <p class="section-desc">Customize colors, fonts, and default theme mode</p>

                <h3 style="margin-top:4px; font-size:14px;">Colors</h3>
                <div class="color-picker-grid" id="colorPickerGrid">
                    <!-- Populated by JS -->
                </div>

                <h3 style="margin-top:24px; font-size:14px;">Fonts</h3>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="brand-headingFont">Heading Font</label>
                        <input type="text" id="brand-headingFont">
                    </div>
                    <div class="form-group">
                        <label for="brand-headingFallback">Heading Fallback</label>
                        <input type="text" id="brand-headingFallback">
                    </div>
                    <div class="form-group">
                        <label for="brand-bodyFont">Body Font</label>
                        <input type="text" id="brand-bodyFont">
                    </div>
                    <div class="form-group">
                        <label for="brand-bodyFallback">Body Fallback</label>
                        <input type="text" id="brand-bodyFallback">
                    </div>
                    <div class="form-group full-width">
                        <label for="brand-googleUrl">Google Fonts URL</label>
                        <input type="text" id="brand-googleUrl">
                        <div class="help-text">Full URL for Google Fonts CSS import</div>
                    </div>
                </div>

                <h3 style="margin-top:24px; font-size:14px;">Default Mode</h3>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="brand-defaultMode">Default Theme Mode</label>
                        <select id="brand-defaultMode">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                </div>

                <div class="settings-save-row">
                    <button onclick="saveBranding()">Save Branding</button>
                    <span class="settings-save-msg" id="msg-branding"></span>
                </div>
            </div>

            <!-- ═══════════════ INTEGRATIONS ═══════════════ -->
            <div class="settings-section" id="tab-integrations">
                <h3>Integrations</h3>
                <p class="section-desc">External service connections and sync configuration</p>

                <h3 style="margin-top:4px; font-size:14px;">OneDrive Sync</h3>
                <div class="settings-form-grid">
                    <div class="form-group full-width">
                        <label for="od-sourceRoot">Source Root Path</label>
                        <input type="text" id="od-sourceRoot">
                        <div class="help-text">Local OneDrive folder for Power Automate intake</div>
                    </div>
                </div>
                <div style="margin-top:12px; max-width:500px;">
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">OneDrive Sync Enabled</div>
                            <div class="settings-toggle-desc">Pull files from OneDrive on intake</div>
                        </div>
                        <div class="toggle-switch"><input type="checkbox" id="od-enabled"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                    <div class="settings-toggle-row">
                        <div>
                            <div class="settings-toggle-label">Delete After Sync</div>
                            <div class="settings-toggle-desc">Remove source files after successful sync</div>
                        </div>
                        <div class="toggle-switch"><input type="checkbox" id="od-deleteAfter"><div class="knobs"></div><div class="layer"></div></div>
                    </div>
                </div>

                <h3 style="margin-top:24px; font-size:14px;">Embeddings</h3>
                <div class="settings-form-grid">
                    <div class="form-group">
                        <label for="emb-provider">Provider</label>
                        <select id="emb-provider">
                            <option value="auto">Auto</option>
                            <option value="openai">OpenAI</option>
                            <option value="local">Local</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="emb-model">Model</label>
                        <input type="text" id="emb-model">
                    </div>
                    <div class="form-group full-width">
                        <label for="emb-baseUrl">Base URL</label>
                        <input type="text" id="emb-baseUrl">
                    </div>
                    <div class="form-group">
                        <label for="emb-dimensions">Dimensions</label>
                        <input type="number" id="emb-dimensions" min="1">
                    </div>
                    <div class="form-group">
                        <label for="emb-batchSize">Batch Size</label>
                        <input type="number" id="emb-batchSize" min="1" max="1000">
                    </div>
                </div>

                <div class="settings-save-row">
                    <button onclick="saveIntegrations()">Save Integrations</button>
                    <span class="settings-save-msg" id="msg-integrations"></span>
                </div>
            </div>

            <!-- ═══════════════ BUSINESS UNITS ═══════════════ -->
            <div class="settings-section" id="tab-business-units">
                <h3>Business Units</h3>
                <p class="section-desc">Manage business unit codes used in project numbers (NNNNN-<strong>CCC</strong>-SS)</p>

                <div style="display:grid; grid-template-columns:1fr 1.5fr; gap:24px;">
                    <div>
                        <h3 style="font-size:14px; margin-bottom:12px;" id="buFormTitle">Add Business Unit</h3>
                        <div class="success-message" id="buSuccessMsg" style="display:none;"></div>
                        <div class="error-message" id="buErrorMsg" style="display:none;"></div>
                        <form id="buForm">
                            <div class="form-group">
                                <label>BU Code (3 digits) *</label>
                                <input type="text" id="buCode" pattern="\d{3}" maxlength="3" placeholder="230" required>
                                <div class="help-text">Must be exactly 3 digits (e.g., 230, 730, 800)</div>
                            </div>
                            <div class="form-group">
                                <label>BU Name *</label>
                                <input type="text" id="buName" placeholder="Engineering" required>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="buDescription" rows="2" placeholder="Optional description"></textarea>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button type="submit" id="buSubmitBtn">Add</button>
                                <button type="button" class="secondary" onclick="resetBuForm()">Clear</button>
                            </div>
                        </form>
                    </div>
                    <div>
                        <div id="buTableContainer"><div class="loading">Loading business units...</div></div>
                    </div>
                </div>
            </div>

            <!-- ═══════════════ USERS & ACCESS ═══════════════ -->
            <div class="settings-section" id="tab-users">
                <h3>Users & Access</h3>
                <p class="section-desc">Manage user accounts and module permissions</p>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <div style="font-size:13px; color:var(--color-text-muted);" id="users-count"></div>
                    <button onclick="openCreateUserModal()">+ Create User</button>
                </div>

                <div style="overflow-x:auto;">
                    <table class="user-mgmt-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Employee</th>
                                <th>Modules</th>
                                <th>Business Units</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody">
                            <tr><td colspan="8" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ═══════════════ THE OBSERVATORY ═══════════════ -->
            <div class="settings-section" id="tab-observatory">
                <h3>The Observatory</h3>
                <p class="section-desc">Manage observations shown on the landing page</p>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <div style="font-size:13px; color:var(--color-text-muted);" id="posts-count"></div>
                    <button onclick="openPostEditor()">+ New Observation</button>
                </div>

                <div style="overflow-x:auto;">
                    <table id="postsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Author</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="postsBody">
                            <tr><td colspan="5" class="loading">Loading observations...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Blog Post Editor Modal -->
<div class="modal-overlay" id="postEditorModal" style="display:none;" onclick="if(event.target===this)closePostEditor()">
    <div class="modal-content" style="max-width:650px;">
        <div class="modal-header">
            <h2 id="pe-title">New Observation</h2>
            <button class="modal-close" onclick="closePostEditor()">&times;</button>
        </div>
        <div id="pe-postId" style="display:none;"></div>
        <div class="form-group">
            <label for="pe-postTitle">Title</label>
            <input type="text" id="pe-postTitle" placeholder="Observation title">
        </div>
        <div class="form-group">
            <label for="pe-excerpt">Excerpt</label>
            <input type="text" id="pe-excerpt" placeholder="Brief summary (optional)">
        </div>
        <div class="form-group">
            <label for="pe-content">Content (Markdown)</label>
            <textarea id="pe-content" rows="12" placeholder="Write your observation in Markdown..." style="font-family:var(--font-mono); font-size:13px;"></textarea>
        </div>
        <div style="display:flex; align-items:center; gap:16px; margin-bottom:12px;">
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:0;">
                <div class="toggle-switch">
                    <input type="checkbox" id="pe-published" onchange="onPublishedToggle()">
                    <div class="knobs"></div>
                    <div class="layer"></div>
                </div>
                Published
            </label>
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:0;">
                <div class="toggle-switch">
                    <input type="checkbox" id="pe-pinned">
                    <div class="knobs"></div>
                    <div class="layer"></div>
                </div>
                Pinned
            </label>
        </div>
        <div class="form-group" style="margin-bottom:12px;">
            <label for="pe-publishAt" style="font-size:13px;">Schedule publish</label>
            <div style="display:flex; align-items:center; gap:8px;">
                <input type="datetime-local" id="pe-publishAt" onchange="onScheduleChange()" style="flex:1;">
                <button type="button" class="secondary" onclick="clearSchedule()" style="padding:6px 12px; font-size:12px;">Clear</button>
            </div>
            <div style="font-size:11px; color:var(--color-text-muted); margin-top:4px;">Leave empty for draft, or set a future date to auto-publish</div>
        </div>
        <div id="pe-error" style="display:none; margin-top:8px; padding:10px 14px; background:var(--color-danger-bg); color:var(--color-danger); border-radius:var(--radius-sm); font-size:13px;"></div>
        <div class="settings-save-row" style="border-top:none; padding-top:12px;">
            <button onclick="savePost()">Save</button>
            <button class="secondary" onclick="closePostEditor()">Cancel</button>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal-overlay" id="createUserModal" style="display:none;" onclick="if(event.target===this)closeCreateUserModal()">
    <div class="modal-content" style="max-width:500px;">
        <div class="modal-header">
            <h2>Create User</h2>
            <button class="modal-close" onclick="closeCreateUserModal()">&times;</button>
        </div>
        <div class="modal-form-grid">
            <div class="form-group">
                <label for="cu-email">Email</label>
                <input type="email" id="cu-email" placeholder="user@company.com">
            </div>
            <div class="form-group">
                <label for="cu-displayName">Display Name</label>
                <input type="text" id="cu-displayName" placeholder="First Last">
            </div>
            <div class="form-group">
                <label for="cu-password">Password</label>
                <input type="password" id="cu-password" placeholder="Min 8 characters">
            </div>
            <div class="form-group">
                <label for="cu-role">Global Role</label>
                <select id="cu-role">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="viewer">Viewer</option>
                </select>
            </div>
        </div>
        <div id="cu-error" style="display:none; margin-top:12px; padding:10px 14px; background:var(--color-danger-bg); color:var(--color-danger); border-radius:var(--radius-sm); font-size:13px;"></div>
        <div class="settings-save-row" style="border-top:none; padding-top:12px;">
            <button onclick="createUser()">Create</button>
            <button class="secondary" onclick="closeCreateUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Module Access Modal -->
<div class="modal-overlay" id="moduleAccessModal" style="display:none;" onclick="if(event.target===this)closeModuleModal()">
    <div class="modal-content" style="max-width:480px;">
        <div class="modal-header">
            <h2>Module Access — <span id="ma-userName"></span></h2>
            <button class="modal-close" onclick="closeModuleModal()">&times;</button>
        </div>
        <div id="ma-userId" style="display:none;"></div>
        <div id="ma-moduleList"></div>
        <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--color-border-light);">
            <div style="font-size:13px; font-weight:600; color:var(--color-text-secondary); margin-bottom:10px;">Grant Access</div>
            <div style="display:flex; gap:8px; align-items:end;">
                <div class="form-group" style="margin-bottom:0; flex:1;">
                    <label for="ma-newModule">Module</label>
                    <select id="ma-newModule"></select>
                </div>
                <div class="form-group" style="margin-bottom:0; flex:1;">
                    <label for="ma-newRole">Role</label>
                    <select id="ma-newRole">
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button onclick="grantModuleAccess()" style="height:38px;">Grant</button>
            </div>
        </div>
    </div>
</div>
<!-- Business Unit Access Modal -->
<div class="modal-overlay" id="buAccessModal" style="display:none;" onclick="if(event.target===this)closeBuModal()">
    <div class="modal-content" style="max-width:440px;">
        <div class="modal-header">
            <h2>Business Unit Access — <span id="bu-userName"></span></h2>
            <button class="modal-close" onclick="closeBuModal()">&times;</button>
        </div>
        <p style="font-size:12.5px; color:var(--color-text-muted); margin-bottom:14px;">
            Select which business units this user can access. No selection means unrestricted (sees all).
        </p>
        <div id="bu-checkboxList"></div>
        <div class="settings-save-row" style="border-top:none; padding-top:12px;">
            <button onclick="saveBuAccess()">Save</button>
            <button class="secondary" onclick="closeBuModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API = '/settings/api';

// ── Tab switching ──
document.querySelectorAll('.settings-nav-item').forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        item.classList.add('active');
        document.getElementById('tab-' + item.dataset.tab).classList.add('active');
    });
});

// ── Feedback ──
function showMsg(id, text, type) {
    const el = document.getElementById('msg-' + id);
    el.textContent = text;
    el.className = 'settings-save-msg visible ' + type;
    setTimeout(() => { el.classList.remove('visible'); }, 3000);
}

// ── Helpers ──
function val(id) { return document.getElementById(id).value; }
function numVal(id) { return parseFloat(document.getElementById(id).value); }
function intVal(id) { return parseInt(document.getElementById(id).value, 10); }
function checked(id) { return document.getElementById(id).checked; }
function setVal(id, v) { document.getElementById(id).value = v; }
function setChecked(id, v) { document.getElementById(id).checked = !!v; }

async function fetchJSON(url) {
    const r = await fetch(url);
    return r.json();
}

async function putJSON(url, data) {
    const r = await fetch(url, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    return { ok: r.ok, data: await r.json() };
}

// ════════════════════════════════════════════
// GENERAL (mixed: DB company name + config branding app_name/tagline)
// ════════════════════════════════════════════

async function loadGeneral() {
    const [budget, branding] = await Promise.all([
        fetchJSON(`${API}/budget`),
        fetchJSON(`${API}/config/branding`)
    ]);
    setVal('gen-companyName', budget.company_name || '');
    setVal('gen-appName', branding.app_name || '');
    setVal('gen-appTagline', branding.app_tagline || '');
}

async function saveGeneral() {
    try {
        // Save company name to DB
        const budgetData = await fetchJSON(`${API}/budget`);
        const r1 = await putJSON(`${API}/budget`, {
            companyName: val('gen-companyName'),
            defaultHourlyRate: budgetData.default_hourly_rate,
            workingHoursPerMonth: budgetData.working_hours_per_month,
            fiscalYearStartMonth: budgetData.fiscal_year_start_month,
            gmpWeightMultiplier: budgetData.gmp_weight_multiplier,
            maxHoursPerWeek: budgetData.max_hours_per_week,
        });
        // Save app name/tagline to config
        const r2 = await putJSON(`${API}/config/branding`, {
            app_name: val('gen-appName'),
            app_tagline: val('gen-appTagline'),
        });
        if (r1.ok && r2.ok) showMsg('general', 'Saved', 'success');
        else showMsg('general', 'Error saving', 'error');
    } catch(e) { showMsg('general', 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// PROJECTS (DB-backed)
// ════════════════════════════════════════════

async function loadProjects() {
    const s = await fetchJSON(`${API}/budget`);
    setVal('proj-hourlyRate', s.default_hourly_rate || 150);
    setVal('proj-hoursPerMonth', s.working_hours_per_month || 176);
    setVal('proj-fiscalMonth', s.fiscal_year_start_month || 1);
    setVal('proj-gmpMultiplier', s.gmp_weight_multiplier || 1.5);
    setVal('proj-maxHoursWeek', s.max_hours_per_week || 40);
}

async function saveProjects() {
    try {
        const budget = await fetchJSON(`${API}/budget`);
        const r = await putJSON(`${API}/budget`, {
            companyName: budget.company_name,
            defaultHourlyRate: numVal('proj-hourlyRate'),
            workingHoursPerMonth: intVal('proj-hoursPerMonth'),
            fiscalYearStartMonth: intVal('proj-fiscalMonth'),
            gmpWeightMultiplier: numVal('proj-gmpMultiplier'),
            maxHoursPerWeek: numVal('proj-maxHoursWeek'),
        });
        showMsg('projects', r.ok ? 'Saved' : 'Error', r.ok ? 'success' : 'error');
    } catch(e) { showMsg('projects', 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// WELDING (config-backed)
// ════════════════════════════════════════════

async function loadWelding() {
    const d = await fetchJSON(`${API}/config/welding.cert_requests`);
    setVal('weld-wcrPrefix', d.wcr_prefix || 'WCR');
    setVal('weld-maxCoupons', d.max_coupons_per_request || 4);
    setVal('weld-wpqExpiry', d.default_wpq_expiration_months || 6);
}

function getWeldingData() {
    return {
        wcr_prefix: val('weld-wcrPrefix'),
        max_coupons_per_request: intVal('weld-maxCoupons'),
        default_wpq_expiration_months: intVal('weld-wpqExpiry'),
    };
}

// ════════════════════════════════════════════
// PIPELINE (config-backed: intake + processing)
// ════════════════════════════════════════════

async function loadPipeline() {
    const [intake, processing] = await Promise.all([
        fetchJSON(`${API}/config/intake`),
        fetchJSON(`${API}/config/processing`)
    ]);
    setVal('intake-onAmbiguous', intake.on_ambiguous || 'move_to_needs_review');
    setVal('intake-onNoMatch', intake.on_no_match || 'move_to_needs_review');
    setChecked('intake-autoExtract', intake.auto_extract);
    setChecked('intake-autoEmbed', intake.auto_embed);
    setVal('proc-batchSize', processing.batch_size || 10);
    setChecked('proc-supersede', processing.auto && processing.auto.supersede_old_revisions);
    setChecked('proc-archive', processing.auto && processing.auto.archive_superseded);
    setChecked('proc-recheck', processing.auto && processing.auto.queue_related_recheck);
}

async function savePipeline() {
    try {
        const r1 = await putJSON(`${API}/config/intake`, {
            auto_extract: checked('intake-autoExtract'),
            auto_embed: checked('intake-autoEmbed'),
            on_ambiguous: val('intake-onAmbiguous'),
            on_no_match: val('intake-onNoMatch'),
        });
        const r2 = await putJSON(`${API}/config/processing`, {
            batch_size: intVal('proc-batchSize'),
            auto: {
                supersede_old_revisions: checked('proc-supersede'),
                archive_superseded: checked('proc-archive'),
                queue_related_recheck: checked('proc-recheck'),
            }
        });
        showMsg('pipeline', (r1.ok && r2.ok) ? 'Saved' : 'Error', (r1.ok && r2.ok) ? 'success' : 'error');
    } catch(e) { showMsg('pipeline', 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// EXTRACTION (config-backed: thresholds + conflicts)
// ════════════════════════════════════════════

async function loadExtraction() {
    const [thresholds, checks] = await Promise.all([
        fetchJSON(`${API}/config/extraction.thresholds`),
        fetchJSON(`${API}/config/conflicts.checks`)
    ]);
    setVal('ext-minConf', thresholds.minimum_confidence || 0.6);
    setVal('ext-highConf', thresholds.high_confidence || 0.9);
    setVal('ext-shadowRate', thresholds.shadow_review_rate || 0.1);
    setChecked('chk-material', checks.material_mismatch);
    setChecked('chk-size', checks.size_mismatch);
    setChecked('chk-tag', checks.tag_duplicate);
    setChecked('chk-instrument', checks.missing_instrument);
    setChecked('chk-weld', checks.weld_inconsistency);
    setChecked('chk-cross', checks.cross_discipline);
}

async function saveExtraction() {
    try {
        const r1 = await putJSON(`${API}/config/extraction.thresholds`, {
            minimum_confidence: numVal('ext-minConf'),
            high_confidence: numVal('ext-highConf'),
            shadow_review_rate: numVal('ext-shadowRate'),
        });
        const r2 = await putJSON(`${API}/config/conflicts.checks`, {
            material_mismatch: checked('chk-material'),
            size_mismatch: checked('chk-size'),
            tag_duplicate: checked('chk-tag'),
            missing_instrument: checked('chk-instrument'),
            weld_inconsistency: checked('chk-weld'),
            cross_discipline: checked('chk-cross'),
        });
        showMsg('extraction', (r1.ok && r2.ok) ? 'Saved' : 'Error', (r1.ok && r2.ok) ? 'success' : 'error');
    } catch(e) { showMsg('extraction', 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// BRANDING (config-backed)
// ════════════════════════════════════════════

const COLOR_LABELS = {
    primary: 'Primary',
    primary_hover: 'Primary Hover',
    primary_subtle: 'Primary Subtle',
    nav_bg: 'Nav Background',
    nav_hover: 'Nav Hover',
    nav_active: 'Nav Active',
    warning: 'Warning',
    dark_surface: 'Dark Surface',
    light_surface: 'Light Surface',
    neutral: 'Neutral',
};

async function loadBranding() {
    const d = await fetchJSON(`${API}/config/branding`);
    // Colors
    const grid = document.getElementById('colorPickerGrid');
    grid.innerHTML = '';
    const colors = d.colors || {};
    for (const [key, label] of Object.entries(COLOR_LABELS)) {
        const hex = colors[key] || '#000000';
        grid.innerHTML += `
            <div class="color-picker-item">
                <input type="color" id="color-${key}" value="${hex}">
                <div>
                    <div class="color-label">${label}</div>
                    <div class="color-hex" id="hex-${key}">${hex}</div>
                </div>
            </div>`;
    }
    // Update hex display on change
    grid.querySelectorAll('input[type="color"]').forEach(inp => {
        inp.addEventListener('input', () => {
            const k = inp.id.replace('color-', '');
            document.getElementById('hex-' + k).textContent = inp.value;
        });
    });
    // Fonts
    const fonts = d.fonts || {};
    setVal('brand-headingFont', fonts.heading || '');
    setVal('brand-headingFallback', fonts.heading_fallback || '');
    setVal('brand-bodyFont', fonts.body || '');
    setVal('brand-bodyFallback', fonts.body_fallback || '');
    setVal('brand-googleUrl', fonts.google_fonts_url || '');
    setVal('brand-defaultMode', d.default_mode || 'light');
}

async function saveBranding() {
    try {
        const colors = {};
        for (const key of Object.keys(COLOR_LABELS)) {
            colors[key] = document.getElementById('color-' + key).value;
        }
        const r = await putJSON(`${API}/config/branding`, {
            colors: colors,
            fonts: {
                heading: val('brand-headingFont'),
                heading_fallback: val('brand-headingFallback'),
                body: val('brand-bodyFont'),
                body_fallback: val('brand-bodyFallback'),
                google_fonts_url: val('brand-googleUrl'),
            },
            default_mode: val('brand-defaultMode'),
        });
        showMsg('branding', r.ok ? 'Saved (reload to see changes)' : 'Error', r.ok ? 'success' : 'error');
    } catch(e) { showMsg('branding', 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// INTEGRATIONS (config-backed: onedrive_sync + embeddings)
// ════════════════════════════════════════════

async function loadIntegrations() {
    const [od, emb] = await Promise.all([
        fetchJSON(`${API}/config/onedrive_sync`),
        fetchJSON(`${API}/config/embeddings`)
    ]);
    setChecked('od-enabled', od.enabled);
    setVal('od-sourceRoot', od.source_root || '');
    setChecked('od-deleteAfter', od.delete_after_sync);
    setVal('emb-provider', emb.provider || 'auto');
    setVal('emb-model', emb.model || '');
    setVal('emb-baseUrl', emb.base_url || '');
    setVal('emb-dimensions', emb.dimensions || 768);
    setVal('emb-batchSize', emb.batch_size || 32);
}

async function saveIntegrations() {
    try {
        const r1 = await putJSON(`${API}/config/onedrive_sync`, {
            enabled: checked('od-enabled'),
            source_root: val('od-sourceRoot'),
            delete_after_sync: checked('od-deleteAfter'),
        });
        const r2 = await putJSON(`${API}/config/embeddings`, {
            provider: val('emb-provider'),
            model: val('emb-model'),
            base_url: val('emb-baseUrl'),
            dimensions: intVal('emb-dimensions'),
            batch_size: intVal('emb-batchSize'),
        });
        showMsg('integrations', (r1.ok && r2.ok) ? 'Saved' : 'Error', (r1.ok && r2.ok) ? 'success' : 'error');
    } catch(e) { showMsg('integrations', 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// Generic config section save
// ════════════════════════════════════════════

async function saveConfigSection(section, data, msgId) {
    try {
        const r = await putJSON(`${API}/config/${section}`, data);
        showMsg(msgId, r.ok ? 'Saved' : (r.data.error || 'Error'), r.ok ? 'success' : 'error');
    } catch(e) { showMsg(msgId, 'Error: ' + e.message, 'error'); }
}

// ════════════════════════════════════════════
// USERS & ACCESS
// ════════════════════════════════════════════

const WEB_MODULES = {{ web_modules | tojson }};

let _usersCache = [];
let _employeesCache = [];

async function loadEmployeesCache() {
    try { _employeesCache = await fetchJSON('/auth/api/employees'); } catch(e) { _employeesCache = []; }
}

async function loadUsers() {
    try {
        if (!_employeesCache.length) await loadEmployeesCache();
        const users = await fetchJSON('/auth/users');
        _usersCache = users;
        const body = document.getElementById('usersBody');
        document.getElementById('users-count').textContent = users.length + ' user' + (users.length !== 1 ? 's' : '');

        if (!users.length) {
            body.innerHTML = '<tr><td colspan="8" class="empty-state">No users found</td></tr>';
            return;
        }

        body.innerHTML = users.map(u => {
            const roleOpts = ['admin', 'user', 'viewer'].map(r =>
                `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r}</option>`
            ).join('');

            const activeLabel = u.is_active ? 'Active' : 'Inactive';
            const activeClass = u.is_active ? 'status-active' : 'status-expired';

            // Employee link dropdown
            const empOpts = ['<option value="">— Unlinked —</option>']
                .concat(_employeesCache.map(e =>
                    `<option value="${e.id}" ${u.employee_id === e.id ? 'selected' : ''}>${esc(e.last_name)}, ${esc(e.first_name)}</option>`
                )).join('');

            return `<tr class="${u.is_active ? '' : 'um-inactive-row'}">
                <td style="font-weight:500;">${esc(u.display_name)}</td>
                <td style="font-size:12.5px; color:var(--color-text-secondary);">${esc(u.email)}</td>
                <td>
                    <select class="um-role-select" onchange="updateRole(${u.id}, this.value)">${roleOpts}</select>
                </td>
                <td>
                    <select class="um-role-select" onchange="linkEmployee(${u.id}, this.value)" style="min-width:140px; font-size:12px;">${empOpts}</select>
                </td>
                <td>
                    <span class="um-modules-cell" id="um-mods-${u.id}">
                        ${u.role === 'admin' ? '<span class="module-pill pill-all">all modules</span>' : '<span class="module-pill pill-loading">...</span>'}
                    </span>
                    ${u.role !== 'admin' ? `<button class="um-action-btn" onclick="openModuleModal(${u.id}, '${esc(u.display_name)}')" title="Edit modules">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>` : ''}
                </td>
                <td>
                    <span class="um-bus-cell" id="um-bus-${u.id}">
                        ${u.role === 'admin' ? '<span class="module-pill pill-all">all</span>' : '<span class="module-pill pill-loading">...</span>'}
                    </span>
                    ${u.role !== 'admin' ? `<button class="um-action-btn" onclick="openBuModal(${u.id}, '${esc(u.display_name)}')" title="Edit business units">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>` : ''}
                </td>
                <td>
                    <button class="status-badge ${activeClass} um-status-btn" onclick="toggleActive(${u.id}, ${u.is_active ? 'false' : 'true'})">${activeLabel}</button>
                </td>
                <td>
                    <button class="um-action-btn" onclick="resetPassword(${u.id})" title="Reset password">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </button>
                </td>
            </tr>`;
        }).join('');

        // Load module access and BU access for non-admin users
        users.filter(u => u.role !== 'admin').forEach(u => {
            loadUserModules(u.id);
            loadUserBUs(u.id);
        });
    } catch(e) {
        document.getElementById('usersBody').innerHTML = '<tr><td colspan="8" class="empty-state">Error loading users</td></tr>';
    }
}

async function linkEmployee(userId, employeeId) {
    try {
        await fetch(`/auth/users/${userId}/employee`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({employee_id: employeeId || null})
        });
    } catch(e) {}
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function loadUserModules(userId) {
    try {
        const mods = await fetchJSON(`/auth/users/${userId}/modules`);
        const el = document.getElementById('um-mods-' + userId);
        if (!el) return;
        const entries = Object.entries(mods);
        if (!entries.length) {
            el.innerHTML = '<span class="module-pill pill-none">none</span>';
            return;
        }
        el.innerHTML = entries.map(([mod, role]) =>
            `<span class="module-pill pill-${role}">${mod}:${role}</span>`
        ).join(' ');
    } catch(e) {}
}

async function updateRole(userId, role) {
    try {
        const r = await fetch(`/auth/users/${userId}/role`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({role})
        });
        if (r.ok) loadUsers();
    } catch(e) {}
}

async function toggleActive(userId, isActive) {
    try {
        await fetch(`/auth/users/${userId}/active`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({is_active: isActive})
        });
        loadUsers();
    } catch(e) {}
}

async function resetPassword(userId) {
    const pw = prompt('Enter new password (min 8 characters):');
    if (!pw) return;
    if (pw.length < 8) { alert('Password must be at least 8 characters'); return; }
    try {
        const r = await fetch(`/auth/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: pw})
        });
        if (r.ok) alert('Password reset. User will be prompted to change on next login.');
        else alert('Error resetting password');
    } catch(e) { alert('Error: ' + e.message); }
}

// ── Create User Modal ──
function openCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'flex';
    document.getElementById('cu-email').value = '';
    document.getElementById('cu-displayName').value = '';
    document.getElementById('cu-password').value = '';
    document.getElementById('cu-role').value = 'user';
    document.getElementById('cu-error').style.display = 'none';
    document.getElementById('cu-email').focus();
}

function closeCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'none';
}

async function createUser() {
    const email = val('cu-email').trim().toLowerCase();
    const display_name = val('cu-displayName').trim();
    const password = val('cu-password');
    const role = val('cu-role');
    const errEl = document.getElementById('cu-error');

    if (!email || !display_name || !password) {
        errEl.textContent = 'All fields are required';
        errEl.style.display = 'block';
        return;
    }
    if (password.length < 8) {
        errEl.textContent = 'Password must be at least 8 characters';
        errEl.style.display = 'block';
        return;
    }

    try {
        const r = await fetch('/auth/users/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, display_name, password, role})
        });
        if (r.ok) {
            closeCreateUserModal();
            loadUsers();
        } else {
            const data = await r.json();
            errEl.textContent = data.description || data.message || 'Error creating user';
            errEl.style.display = 'block';
        }
    } catch(e) {
        errEl.textContent = 'Error: ' + e.message;
        errEl.style.display = 'block';
    }
}

// ── Module Access Modal ──
let _maUserId = null;

function openModuleModal(userId, displayName) {
    _maUserId = userId;
    document.getElementById('ma-userName').textContent = displayName;
    document.getElementById('moduleAccessModal').style.display = 'flex';
    // Populate module dropdown from config
    const sel = document.getElementById('ma-newModule');
    sel.innerHTML = Object.entries(WEB_MODULES).map(([k, v]) =>
        `<option value="${k}">${v.label}</option>`
    ).join('');
    loadModuleAccessModal(userId);
}

function closeModuleModal() {
    document.getElementById('moduleAccessModal').style.display = 'none';
    _maUserId = null;
}

async function loadModuleAccessModal(userId) {
    const el = document.getElementById('ma-moduleList');
    try {
        const mods = await fetchJSON(`/auth/users/${userId}/modules`);
        const entries = Object.entries(mods);
        if (!entries.length) {
            el.innerHTML = '<div style="padding:12px 0; color:var(--color-text-muted); font-size:13px;">No module access granted</div>';
            return;
        }
        el.innerHTML = entries.map(([mod, role]) => `
            <div class="um-module-row">
                <span class="module-pill pill-${role}">${mod}</span>
                <span style="font-size:12px; color:var(--color-text-muted);">${role}</span>
                <button class="um-action-btn danger" onclick="revokeModuleAccess(${userId}, '${mod}')" title="Revoke">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
        `).join('');
    } catch(e) {
        el.innerHTML = '<div style="color:var(--color-danger);">Error loading modules</div>';
    }
}

async function grantModuleAccess() {
    if (!_maUserId) return;
    const module = val('ma-newModule');
    const role = val('ma-newRole');
    try {
        await fetch(`/auth/users/${_maUserId}/modules`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({module, role})
        });
        loadModuleAccessModal(_maUserId);
        loadUserModules(_maUserId);
    } catch(e) {}
}

async function revokeModuleAccess(userId, module) {
    try {
        await fetch(`/auth/users/${userId}/modules/${module}`, {method: 'DELETE'});
        loadModuleAccessModal(userId);
        loadUserModules(userId);
    } catch(e) {}
}

// ════════════════════════════════════════════
// BUSINESS UNIT ACCESS
// ════════════════════════════════════════════

let _allBUs = [];  // cached list of all business units
let _buUserId = null;

async function loadAllBUs() {
    try {
        _allBUs = await fetchJSON('/projects/api/business-units');
    } catch(e) { _allBUs = []; }
}

async function loadUserBUs(userId) {
    try {
        const buIds = await fetchJSON(`/auth/users/${userId}/business-units`);
        const el = document.getElementById('um-bus-' + userId);
        if (!el) return;
        if (!buIds.length) {
            el.innerHTML = '<span class="module-pill pill-all">all</span>';
            return;
        }
        // Map IDs to codes using cached BU list
        const pills = buIds.map(id => {
            const bu = _allBUs.find(b => b.id === id);
            return `<span class="module-pill pill-editor">${bu ? bu.code : id}</span>`;
        }).join(' ');
        el.innerHTML = pills;
    } catch(e) {}
}

function openBuModal(userId, displayName) {
    _buUserId = userId;
    document.getElementById('bu-userName').textContent = displayName;
    document.getElementById('buAccessModal').style.display = 'flex';
    loadBuCheckboxes(userId);
}

function closeBuModal() {
    document.getElementById('buAccessModal').style.display = 'none';
    _buUserId = null;
}

async function loadBuCheckboxes(userId) {
    const container = document.getElementById('bu-checkboxList');
    container.innerHTML = '<div style="padding:8px 0; color:var(--color-text-muted); font-size:13px;">Loading...</div>';

    try {
        const assigned = await fetchJSON(`/auth/users/${userId}/business-units`);
        const assignedSet = new Set(assigned);

        if (!_allBUs.length) {
            container.innerHTML = '<div style="padding:8px 0; color:var(--color-text-muted); font-size:13px;">No business units defined</div>';
            return;
        }

        container.innerHTML = _allBUs.map(bu => `
            <label class="bu-checkbox-row">
                <input type="checkbox" value="${bu.id}" ${assignedSet.has(bu.id) ? 'checked' : ''}>
                <span class="bu-checkbox-code">${esc(bu.code)}</span>
                <span class="bu-checkbox-name">${esc(bu.name)}</span>
            </label>
        `).join('');
    } catch(e) {
        container.innerHTML = '<div style="color:var(--color-danger);">Error loading business units</div>';
    }
}

async function saveBuAccess() {
    if (!_buUserId) return;
    const userId = _buUserId;  // capture before close nullifies it
    const checkboxes = document.querySelectorAll('#bu-checkboxList input[type="checkbox"]');
    const selectedIds = [];
    checkboxes.forEach(cb => { if (cb.checked) selectedIds.push(parseInt(cb.value)); });

    try {
        const r = await fetch(`/auth/users/${userId}/business-units`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({business_unit_ids: selectedIds})
        });
        if (r.ok) {
            closeBuModal();
            loadUserBUs(userId);
        }
    } catch(e) {}
}

// ════════════════════════════════════════════
// THE OBSERVATORY (Blog CRUD)
// ════════════════════════════════════════════

let _editingPostId = null;

async function loadPosts() {
    try {
        const posts = await fetchJSON('/blog/api/posts');
        const body = document.getElementById('postsBody');
        document.getElementById('posts-count').textContent = posts.length + ' observation' + (posts.length !== 1 ? 's' : '');

        if (!posts.length) {
            body.innerHTML = '<tr><td colspan="5" class="empty-state">No observations yet</td></tr>';
            return;
        }

        body.innerHTML = posts.map(p => {
            let statusClass, statusText;
            if (p.published) {
                statusClass = 'status-active';
                statusText = 'Published';
            } else if (p.publish_at) {
                statusClass = 'status-scheduled';
                statusText = 'Scheduled';
            } else {
                statusClass = 'status-pending';
                statusText = 'Draft';
            }
            const schedDate = p.publish_at ? `<div style="font-size:10px; color:var(--color-text-muted); margin-top:2px;">${p.publish_at.slice(0,16).replace('T',' ')}</div>` : '';
            const pinIcon = p.pinned ? ' &#9733;' : '';
            return `<tr>
                <td style="font-weight:500;">${esc(p.title)}${pinIcon}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span>${schedDate}</td>
                <td style="font-size:12.5px; color:var(--color-text-secondary);">${esc(p.author_name || 'Admin')}</td>
                <td style="font-size:12.5px; color:var(--color-text-muted);">${p.created_at ? p.created_at.slice(0,10) : ''}</td>
                <td>
                    <button class="um-action-btn" onclick='editPost(${JSON.stringify(p).replace(/'/g,"&#39;")})' title="Edit">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                    <button class="um-action-btn danger" onclick="deletePost(${p.id})" title="Delete">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </td>
            </tr>`;
        }).join('');
    } catch(e) {
        document.getElementById('postsBody').innerHTML = '<tr><td colspan="5" class="empty-state">Error loading posts</td></tr>';
    }
}

function openPostEditor() {
    _editingPostId = null;
    document.getElementById('pe-title').textContent = 'New Observation';
    document.getElementById('pe-postTitle').value = '';
    document.getElementById('pe-excerpt').value = '';
    document.getElementById('pe-content').value = '';
    setChecked('pe-published', false);
    setChecked('pe-pinned', false);
    document.getElementById('pe-publishAt').value = '';
    document.getElementById('pe-error').style.display = 'none';
    document.getElementById('postEditorModal').style.display = 'flex';
    document.getElementById('pe-postTitle').focus();
}

function editPost(post) {
    _editingPostId = post.id;
    document.getElementById('pe-title').textContent = 'Edit Observation';
    document.getElementById('pe-postTitle').value = post.title || '';
    document.getElementById('pe-excerpt').value = post.excerpt || '';
    document.getElementById('pe-content').value = post.content_md || '';
    setChecked('pe-published', !!post.published);
    setChecked('pe-pinned', !!post.pinned);
    // Populate schedule picker — convert SQLite format to datetime-local format
    const pa = post.publish_at || '';
    document.getElementById('pe-publishAt').value = pa ? pa.replace(' ', 'T').slice(0,16) : '';
    document.getElementById('pe-error').style.display = 'none';
    document.getElementById('postEditorModal').style.display = 'flex';
}

function closePostEditor() {
    document.getElementById('postEditorModal').style.display = 'none';
    _editingPostId = null;
}

function onPublishedToggle() {
    // Checking Published → clears the schedule (mutually exclusive)
    if (checked('pe-published')) {
        document.getElementById('pe-publishAt').value = '';
    }
}

function onScheduleChange() {
    // Setting a schedule date → unchecks Published
    if (document.getElementById('pe-publishAt').value) {
        setChecked('pe-published', false);
    }
}

function clearSchedule() {
    document.getElementById('pe-publishAt').value = '';
}

async function savePost() {
    const title = val('pe-postTitle').trim();
    const errEl = document.getElementById('pe-error');

    if (!title) {
        errEl.textContent = 'Title is required';
        errEl.style.display = 'block';
        return;
    }

    // Convert datetime-local value to SQLite format (replace T with space)
    let publishAt = document.getElementById('pe-publishAt').value || '';
    if (publishAt) {
        publishAt = publishAt.replace('T', ' ');
        if (publishAt.length === 16) publishAt += ':00';  // append seconds
    }

    const payload = {
        title: title,
        content_md: val('pe-content'),
        excerpt: val('pe-excerpt'),
        published: checked('pe-published'),
        pinned: checked('pe-pinned'),
        publish_at: publishAt || null,
    };

    try {
        const url = _editingPostId ? `/blog/api/posts/${_editingPostId}` : '/blog/api/posts';
        const method = _editingPostId ? 'PUT' : 'POST';
        const r = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });
        if (r.ok) {
            closePostEditor();
            loadPosts();
        } else {
            const data = await r.json();
            errEl.textContent = data.error || 'Error saving post';
            errEl.style.display = 'block';
        }
    } catch(e) {
        errEl.textContent = 'Error: ' + e.message;
        errEl.style.display = 'block';
    }
}

async function deletePost(postId) {
    if (!confirm('Delete this observation?')) return;
    try {
        await fetch(`/blog/api/posts/${postId}`, {method: 'DELETE'});
        loadPosts();
    } catch(e) {}
}

// ════════════════════════════════════════════
// BUSINESS UNITS
// ════════════════════════════════════════════

let _buList = [];
let _buEditId = null;

document.getElementById('buCode').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

document.getElementById('buForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const buData = {
        code: document.getElementById('buCode').value,
        name: document.getElementById('buName').value,
        description: document.getElementById('buDescription').value,
    };
    try {
        const url = _buEditId
            ? `/projects/api/business-units/${_buEditId}`
            : '/projects/api/business-units';
        const method = _buEditId ? 'PUT' : 'POST';
        const r = await fetch(url, {
            method, headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(buData)
        });
        const result = await r.json();
        if (r.ok) {
            showBuSuccess(_buEditId ? 'Updated!' : 'Added!');
            resetBuForm();
            loadBUs();
            loadAllBUs();  // refresh cached BU list used by Users & Access
        } else {
            showBuError(result.error || 'Failed to save');
        }
    } catch(err) { showBuError('Error: ' + err.message); }
});

function resetBuForm() {
    document.getElementById('buForm').reset();
    _buEditId = null;
    document.getElementById('buSubmitBtn').textContent = 'Add';
    document.getElementById('buFormTitle').textContent = 'Add Business Unit';
}

function editBUItem(id) {
    const bu = _buList.find(b => b.id === id);
    if (!bu) return;
    document.getElementById('buCode').value = bu.code;
    document.getElementById('buName').value = bu.name;
    document.getElementById('buDescription').value = bu.description || '';
    _buEditId = id;
    document.getElementById('buSubmitBtn').textContent = 'Update';
    document.getElementById('buFormTitle').textContent = 'Edit Business Unit';
}

async function deleteBUItem(id) {
    if (!confirm('Delete this business unit?')) return;
    try {
        const r = await fetch(`/projects/api/business-units/${id}`, {method: 'DELETE'});
        const result = await r.json();
        if (r.ok) { showBuSuccess('Deleted!'); loadBUs(); loadAllBUs(); }
        else showBuError(result.error || 'Cannot delete');
    } catch(err) { showBuError('Error: ' + err.message); }
}

async function loadBUs() {
    try {
        const r = await fetch('/projects/api/business-units');
        _buList = await r.json();
        const container = document.getElementById('buTableContainer');
        if (!_buList.length) {
            container.innerHTML = '<div class="empty-state">No business units yet. Add your first one!</div>';
            return;
        }
        let html = '<table><thead><tr><th>Code</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
        _buList.forEach(bu => {
            html += `<tr>
                <td><span class="bu-code">${bu.code}</span></td>
                <td><strong>${bu.name}</strong></td>
                <td>${bu.description || '<span style="color:var(--color-text-muted);">-</span>'}</td>
                <td><div class="action-buttons">
                    <button class="action-btn secondary" onclick="editBUItem(${bu.id})">Edit</button>
                    <button class="action-btn danger" onclick="deleteBUItem(${bu.id})">Delete</button>
                </div></td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch(err) { showBuError('Failed to load business units'); }
}

function showBuSuccess(msg) {
    const el = document.getElementById('buSuccessMsg');
    el.textContent = msg; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
}

function showBuError(msg) {
    const el = document.getElementById('buErrorMsg');
    el.textContent = msg; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

// ═══ Load all on page init ═══
loadGeneral();
loadProjects();
loadWelding();
loadPipeline();
loadExtraction();
loadBranding();
loadIntegrations();
loadBUs();
loadAllBUs().then(() => loadUsers());
loadPosts();
</script>
{% endblock %}
