{% extends "base.html" %}

{% block title %}Projects - QMS{% endblock %}

{% block content %}
<div class="page-header" style="display:flex;justify-content:space-between;align-items:center;">
    <div>
        <h1>Projects</h1>
        <p class="subtitle">Manage projects and budgets</p>
    </div>
    <div style="display:flex;gap:10px;">
        <button onclick="openProjectModal()">+ Add Project</button>
        <button class="secondary" onclick="document.getElementById('importSection').style.display = document.getElementById('importSection').style.display === 'none' ? 'block' : 'none'">Import</button>
    </div>
</div>

<!-- Project Form Modal -->
<div id="projectModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="formTitle" style="margin:0;border:none;padding:0;">Add New Project</h2>
            <button class="modal-close" onclick="closeProjectModal()">&times;</button>
        </div>
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        <form id="projectForm">
            <div class="modal-form-grid">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>Project Number *</label>
                    <input type="text" id="projectBase" pattern="\d{5}" placeholder="07587" maxlength="5" required style="text-align:center;width:120px;">
                    <div class="help-text">5-digit base number (e.g., 07587)</div>
                </div>
                <div class="form-group" style="grid-column:1/-1;">
                    <label>Description</label>
                    <textarea id="projectDescription" rows="2" placeholder="Full project scope description"></textarea>
                </div>
                <div class="form-group">
                    <label>Project Manager</label>
                    <input type="text" id="projectManager">
                </div>
                <div class="form-group">
                    <label>Stage *</label>
                    <select id="projectStage" required>
                        {% for stage in stages %}
                        <option value="{{ stage }}">{{ stage }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Budget</label>
                    <input type="number" id="totalBudget" step="0.01" value="0" readonly style="background:var(--color-surface-alt);color:var(--color-text-muted);">
                    <div class="help-text" id="budgetHint">Auto-calculated from job budgets</div>
                </div>
                <div class="form-group">
                    <label>Weight Adjustment</label>
                    <input type="number" id="weightAdjustment" step="0.1" value="1.0" min="0.5" max="2.0">
                    <div class="help-text">Default: 1.0 (0.5 - 2.0)</div>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>

            <h3 style="margin-top:20px;padding-top:15px;border-top:1px solid #ecf0f1;">Owner Information</h3>
            <div class="modal-form-grid">
                <div class="form-group">
                    <label>Owner Name</label>
                    <input type="text" id="ownerName">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="ownerAddress">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="ownerCity">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <select id="ownerState">
                        <option value="">Select State</option>
                        <option value="AL">AL - Alabama</option><option value="AK">AK - Alaska</option>
                        <option value="AZ">AZ - Arizona</option><option value="AR">AR - Arkansas</option>
                        <option value="CA">CA - California</option><option value="CO">CO - Colorado</option>
                        <option value="CT">CT - Connecticut</option><option value="DE">DE - Delaware</option>
                        <option value="FL">FL - Florida</option><option value="GA">GA - Georgia</option>
                        <option value="HI">HI - Hawaii</option><option value="ID">ID - Idaho</option>
                        <option value="IL">IL - Illinois</option><option value="IN">IN - Indiana</option>
                        <option value="IA">IA - Iowa</option><option value="KS">KS - Kansas</option>
                        <option value="KY">KY - Kentucky</option><option value="LA">LA - Louisiana</option>
                        <option value="ME">ME - Maine</option><option value="MD">MD - Maryland</option>
                        <option value="MA">MA - Massachusetts</option><option value="MI">MI - Michigan</option>
                        <option value="MN">MN - Minnesota</option><option value="MS">MS - Mississippi</option>
                        <option value="MO">MO - Missouri</option><option value="MT">MT - Montana</option>
                        <option value="NE">NE - Nebraska</option><option value="NV">NV - Nevada</option>
                        <option value="NH">NH - New Hampshire</option><option value="NJ">NJ - New Jersey</option>
                        <option value="NM">NM - New Mexico</option><option value="NY">NY - New York</option>
                        <option value="NC">NC - North Carolina</option><option value="ND">ND - North Dakota</option>
                        <option value="OH">OH - Ohio</option><option value="OK">OK - Oklahoma</option>
                        <option value="OR">OR - Oregon</option><option value="PA">PA - Pennsylvania</option>
                        <option value="RI">RI - Rhode Island</option><option value="SC">SC - South Carolina</option>
                        <option value="SD">SD - South Dakota</option><option value="TN">TN - Tennessee</option>
                        <option value="TX">TX - Texas</option><option value="UT">UT - Utah</option>
                        <option value="VT">VT - Vermont</option><option value="VA">VA - Virginia</option>
                        <option value="WA">WA - Washington</option><option value="WV">WV - West Virginia</option>
                        <option value="WI">WI - Wisconsin</option><option value="WY">WY - Wyoming</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Zip Code</label>
                    <input type="text" id="ownerZip" maxlength="10" placeholder="12345">
                </div>
                <div class="form-group" style="grid-column:1/-1;">
                    <label>Notes</label>
                    <textarea id="notes"></textarea>
                </div>
            </div>

            <!-- Allocation management (visible when editing) -->
            <div id="allocationSection" style="display:none;margin-top:20px;padding-top:15px;border-top:2px solid #3498db;">
                <h3>BU Allocations</h3>
                <p style="color:#7f8c8d;font-size:13px;margin-bottom:10px;">Break down the project budget by business unit</p>
                <div id="allocationList"></div>
                <div style="display:grid;grid-template-columns:1fr 80px 120px 80px auto;gap:8px;align-items:end;margin-top:10px;">
                    <div>
                        <label style="font-size:12px;">Business Unit</label>
                        <select id="allocBU" style="font-size:13px;">
                            <option value="">Select BU</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px;">Subjob</label>
                        <input type="text" id="allocSubjob" value="00" maxlength="2" pattern="\d{2}" style="font-size:13px;text-align:center;">
                    </div>
                    <div>
                        <label style="font-size:12px;">Budget</label>
                        <input type="number" id="allocBudget" step="0.01" style="font-size:13px;">
                    </div>
                    <div>
                        <label style="font-size:12px;">Weight</label>
                        <input type="number" id="allocWeight" value="1.0" step="0.1" min="0.5" max="2.0" style="font-size:13px;">
                    </div>
                    <button class="success" onclick="addAllocation()" style="height:36px;font-size:13px;">Add</button>
                </div>
            </div>

            <div style="margin-top:20px;padding-top:15px;border-top:1px solid #ecf0f1;display:flex;gap:10px;">
                <button type="submit" id="submitBtn">Add Project</button>
                <button type="button" class="secondary" onclick="closeProjectModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="success-message" id="pageSuccessMessage"></div>
<div class="error-message" id="pageErrorMessage"></div>

<div class="card">
    <h2>All Projects</h2>
    <div class="filter-bar">
        <select id="stageFilter" onchange="renderProjects()">
            <option value="">All Stages</option>
            {% for stage in stages %}
            <option value="{{ stage }}">{{ stage }}</option>
            {% endfor %}
        </select>
        <select id="sortBy" onchange="renderProjects()">
            <option value="number-asc">Project # (Low → High)</option>
            <option value="number-desc">Project # (High → Low)</option>
            <option value="name-asc">Name (A → Z)</option>
            <option value="name-desc">Name (Z → A)</option>
            <option value="budget-desc">Budget (High → Low)</option>
            <option value="budget-asc">Budget (Low → High)</option>
            <option value="jobs-desc">Jobs (Most → Fewest)</option>
            <option value="location-asc">Location (A → Z)</option>
            <option value="newest" selected>Newest First</option>
            <option value="oldest">Oldest First</option>
        </select>
        <input type="text" id="searchFilter" placeholder="Search projects, jobs, PM..." oninput="renderProjects()">
        <div class="view-toggle" style="margin-left:auto;display:flex;gap:0;">
            <button id="viewProject" class="toggle-btn active" onclick="setViewMode('project')">By Project</button>
            <button id="viewBU" class="toggle-btn" onclick="setViewMode('bu')">By BU</button>
        </div>
        <button id="expandAllBtn" class="secondary" onclick="toggleExpandAll()" style="font-size:12px;padding:4px 12px;">▶ Expand All</button>
    </div>
    <div id="projectsTable"><div class="loading">Loading projects...</div></div>
</div>

<!-- Bulk Actions Toolbar (fixed bottom bar) -->
<div id="bulkToolbar" class="bulk-toolbar" style="display:none;">
    <span id="bulkCount" class="bulk-count">0 jobs selected</span>
    <div class="bulk-actions">
        <select id="bulkStageSelect" class="bulk-input">
            <option value="">Set Stage...</option>
            {% for stage in stages %}
            <option value="{{ stage }}">{{ stage }}</option>
            {% endfor %}
        </select>
        <button class="bulk-btn" onclick="bulkSetStage()">Apply Stage</button>
        <span class="bulk-sep">|</span>
        <button class="bulk-btn" onclick="bulkAction('set_projection', true)">Proj ON</button>
        <button class="bulk-btn" onclick="bulkAction('set_projection', false)">Proj OFF</button>
        <span class="bulk-sep">|</span>
        <input type="number" id="bulkWeightInput" class="bulk-input" min="0" max="2" step="0.1" value="1.0" style="width:70px;">
        <button class="bulk-btn" onclick="bulkSetWeight()">Set Weight</button>
        <span class="bulk-sep">|</span>
        <button class="bulk-btn bulk-btn-danger" onclick="bulkAction('delete')">Delete</button>
    </div>
    <button class="bulk-btn bulk-btn-clear" onclick="clearSelection()">✕ Clear</button>
</div>

<div class="card" id="importSection" style="display:none;">
    <h2>Bulk Import</h2>
    <p style="color:#7f8c8d;margin-bottom:10px;font-size:13px;">Import multiple projects from an Excel file or Procore CSV export</p>
    <div class="import-buttons">
        <button onclick="downloadTemplate()">Download Template</button>
        <input type="file" id="importFile" accept=".xlsx" style="display:none;" onchange="importProjects(this.files[0])">
        <button class="success" onclick="document.getElementById('importFile').click()">Import from Excel</button>
        <input type="file" id="procoreFile" accept=".csv" style="display:none;" onchange="importProcore(this.files[0])">
        <button class="success" onclick="document.getElementById('procoreFile').click()">Import from Procore</button>
    </div>
    <div id="importResults" style="margin-top:15px;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let projects = [];
    let businessUnits = [];
    let currentEditId = null;
    let expandedProjects = new Set();
    let viewMode = 'project'; // 'project' or 'bu'
    let selectedJobs = new Set();
    const API_BASE = '/projects/api';
    const STAGES = {{ stages|tojson }};

    function toggleJobSelect(allocId, checkbox) {
        if (checkbox.checked) selectedJobs.add(allocId);
        else selectedJobs.delete(allocId);
        updateBulkToolbar();
    }

    function toggleSelectAll(masterCb) {
        const checkboxes = document.querySelectorAll('.job-select-cb');
        checkboxes.forEach(cb => {
            const id = parseInt(cb.dataset.allocId);
            cb.checked = masterCb.checked;
            if (masterCb.checked) selectedJobs.add(id);
            else selectedJobs.delete(id);
        });
        updateBulkToolbar();
    }

    function updateBulkToolbar() {
        const toolbar = document.getElementById('bulkToolbar');
        const count = selectedJobs.size;
        if (count > 0) {
            toolbar.style.display = 'flex';
            document.getElementById('bulkCount').textContent = `${count} job${count > 1 ? 's' : ''} selected`;
        } else {
            toolbar.style.display = 'none';
        }
    }

    function clearSelection() {
        selectedJobs.clear();
        document.querySelectorAll('.job-select-cb').forEach(cb => cb.checked = false);
        const master = document.getElementById('selectAllCb');
        if (master) master.checked = false;
        updateBulkToolbar();
    }

    async function bulkAction(action, value) {
        const ids = Array.from(selectedJobs);
        if (ids.length === 0) return;
        if (action === 'delete' && !confirm(`Delete ${ids.length} job allocation(s)? This cannot be undone.`)) return;
        try {
            const res = await fetch(`${API_BASE}/allocations/bulk`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids, action, value })
            });
            const result = await res.json();
            if (res.ok) {
                showSuccess(`Updated ${result.updated} allocation(s)`);
                selectedJobs.clear();
                loadProjects();
            } else {
                showError(result.error || 'Bulk action failed');
            }
        } catch (e) { showError('Bulk action failed'); }
    }

    function bulkSetStage() {
        const stage = document.getElementById('bulkStageSelect').value;
        if (stage) bulkAction('set_stage', stage);
    }

    function bulkSetWeight() {
        const w = parseFloat(document.getElementById('bulkWeightInput').value);
        if (!isNaN(w) && w >= 0 && w <= 2) bulkAction('set_weight', w);
    }

    function setViewMode(mode) {
        viewMode = mode;
        expandedProjects.clear();
        document.getElementById('viewProject').classList.toggle('active', mode === 'project');
        document.getElementById('viewBU').classList.toggle('active', mode === 'bu');
        const btn = document.getElementById('expandAllBtn');
        btn.textContent = '▶ Expand All';
        renderProjects();
    }

    document.getElementById('projectBase').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    async function loadBusinessUnits() {
        try {
            const response = await fetch(`${API_BASE}/business-units`);
            businessUnits = await response.json();
            populateAllocBUDropdown();
        } catch (error) {
            console.error('Error loading business units:', error);
        }
    }

    function populateAllocBUDropdown() {
        const select = document.getElementById('allocBU');
        select.innerHTML = '<option value="">Select BU</option>';
        businessUnits.forEach(bu => {
            const option = document.createElement('option');
            option.value = bu.code;
            option.textContent = `${bu.code} - ${bu.name}`;
            select.appendChild(option);
        });
    }

    document.getElementById('projectForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const base = document.getElementById('projectBase').value;
        const projectData = {
            name: document.getElementById('projectName').value,
            code: base,
            manager: document.getElementById('projectManager').value,
            stage: document.getElementById('projectStage').value,
            totalBudget: parseFloat(document.getElementById('totalBudget').value),
            weightAdjustment: parseFloat(document.getElementById('weightAdjustment').value) || 1.0,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            ownerName: document.getElementById('ownerName').value,
            ownerAddress: document.getElementById('ownerAddress').value,
            ownerCity: document.getElementById('ownerCity').value,
            ownerState: document.getElementById('ownerState').value,
            ownerZip: document.getElementById('ownerZip').value,
            notes: document.getElementById('notes').value,
            description: document.getElementById('projectDescription').value
        };

        try {
            const url = currentEditId
                ? `${API_BASE}/projects/${currentEditId}`
                : `${API_BASE}/projects`;
            const method = currentEditId ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method, headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectData)
            });
            const result = await response.json();
            if (response.ok) {
                closeProjectModal();
                showSuccess(currentEditId ? 'Project updated!' : 'Project added!');
                loadProjects();
            } else {
                showError(result.error || 'Failed to save project');
            }
        } catch (error) {
            console.error('Error saving project:', error);
            showError('Failed to save project');
        }
    });

    function openProjectModal() {
        resetForm();
        document.getElementById('projectModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeProjectModal() {
        document.getElementById('projectModal').style.display = 'none';
        document.body.style.overflow = '';
        resetForm();
    }

    function resetForm() {
        document.getElementById('projectForm').reset();
        document.getElementById('projectBase').value = '';
        document.getElementById('projectDescription').value = '';
        document.getElementById('weightAdjustment').value = '1.0';
        document.getElementById('ownerName').value = '';
        document.getElementById('ownerAddress').value = '';
        document.getElementById('ownerCity').value = '';
        document.getElementById('ownerState').value = '';
        document.getElementById('ownerZip').value = '';
        document.getElementById('allocationSection').style.display = 'none';
        document.getElementById('allocationList').innerHTML = '';
        document.getElementById('budgetHint').textContent = 'Auto-calculated from job budgets';
        currentEditId = null;
        document.getElementById('submitBtn').textContent = 'Add Project';
        document.getElementById('formTitle').textContent = 'Add New Project';
    }

    function editProject(id) {
        const project = projects.find(p => p.id === id);
        if (!project) return;
        document.getElementById('projectName').value = project.name;
        document.getElementById('projectBase').value = project.number || '';
        document.getElementById('projectDescription').value = project.description || '';
        document.getElementById('projectManager').value = project.pm || '';
        document.getElementById('projectStage').value = project.stage;
        document.getElementById('totalBudget').value = project.total_budget || 0;
        document.getElementById('weightAdjustment').value = project.weight_adjustment || 1.0;
        document.getElementById('startDate').value = project.start_date || '';
        document.getElementById('endDate').value = project.end_date || '';
        document.getElementById('ownerName').value = project.client || '';
        document.getElementById('ownerAddress').value = project.street || '';
        document.getElementById('ownerCity').value = project.city || '';
        document.getElementById('ownerState').value = project.state || '';
        document.getElementById('ownerZip').value = project.zip || '';
        document.getElementById('notes').value = project.notes || '';
        currentEditId = id;
        document.getElementById('submitBtn').textContent = 'Update Project';
        document.getElementById('formTitle').textContent = 'Edit Project';
        document.getElementById('allocationSection').style.display = 'block';
        loadAllocations(id);
        document.getElementById('projectModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    async function loadAllocations(projectId) {
        try {
            const response = await fetch(`${API_BASE}/projects/${projectId}/allocations`);
            const allocs = await response.json();
            renderAllocations(allocs, projectId);
        } catch (error) {
            console.error('Error loading allocations:', error);
        }
    }

    function renderAllocations(allocs, projectId) {
        const container = document.getElementById('allocationList');
        if (!allocs || allocs.length === 0) {
            container.innerHTML = '<p style="color:var(--color-text-muted);font-size:13px;">No allocations yet. Add a BU allocation below.</p>';
            document.getElementById('budgetHint').textContent = '';
            return;
        }
        let total = 0;
        let html = '<table style="font-size:13px;margin-bottom:5px;"><thead><tr><th>BU</th><th>Job Code</th><th>Budget</th><th>Weight</th><th></th></tr></thead><tbody>';
        allocs.forEach(a => {
            total += a.allocated_budget;
            html += `<tr>`;
            html += `<td>${a.bu_code} - ${a.bu_name}</td>`;
            html += `<td>${a.job_code}</td>`;
            html += `<td class="currency">$${a.allocated_budget.toLocaleString()}</td>`;
            html += `<td>${a.weight_adjustment}x</td>`;
            html += `<td><button class="action-btn danger" style="font-size:11px;padding:2px 8px;" onclick="deleteAllocation(${projectId},${a.id})">x</button></td>`;
            html += `</tr>`;
        });
        html += `<tr style="font-weight:bold;border-top:2px solid var(--color-border);"><td colspan="2">Total</td><td class="currency">$${total.toLocaleString()}</td><td colspan="2"></td></tr>`;
        html += '</tbody></table>';
        container.innerHTML = html;

        const formBudget = parseFloat(document.getElementById('totalBudget').value) || 0;
        if (Math.abs(total - formBudget) > 0.01) {
            document.getElementById('budgetHint').textContent = `Allocation total: $${total.toLocaleString()} (auto-synced on save)`;
        } else {
            document.getElementById('budgetHint').textContent = '';
        }
    }

    async function addAllocation() {
        if (!currentEditId) {
            showError('Save the project first, then add allocations.');
            return;
        }
        const buCode = document.getElementById('allocBU').value;
        if (!buCode) { showError('Select a business unit'); return; }

        const data = {
            buCode: buCode,
            subjob: document.getElementById('allocSubjob').value || '00',
            budget: parseFloat(document.getElementById('allocBudget').value) || 0,
            weight: parseFloat(document.getElementById('allocWeight').value) || 1.0
        };

        try {
            const response = await fetch(`${API_BASE}/projects/${currentEditId}/allocations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                renderAllocations(result, currentEditId);
                document.getElementById('allocBudget').value = '';
                document.getElementById('allocSubjob').value = '00';
                document.getElementById('allocWeight').value = '1.0';
                loadProjects();
            } else {
                showError(result.error || 'Failed to add allocation');
            }
        } catch (error) {
            showError('Failed to add allocation');
        }
    }

    async function deleteAllocation(projectId, allocId) {
        try {
            const response = await fetch(`${API_BASE}/projects/${projectId}/allocations/${allocId}`, { method: 'DELETE' });
            const result = await response.json();
            if (response.ok) {
                renderAllocations(result, projectId);
                loadProjects();
            }
        } catch (error) {
            showError('Failed to delete allocation');
        }
    }

    async function deleteProject(id) {
        if (!confirm('Are you sure you want to delete this project?')) return;
        try {
            const response = await fetch(`${API_BASE}/projects/${id}`, { method: 'DELETE' });
            if (response.ok) { showSuccess('Project deleted!'); loadProjects(); }
            else showError('Failed to delete project');
        } catch (error) { showError('Failed to delete project'); }
    }

    async function loadProjects() {
        try {
            const response = await fetch(`${API_BASE}/projects/hierarchical`);
            projects = await response.json();
            renderProjects();
        } catch (error) { showError('Failed to load projects'); }
    }

    function getStageClass(stage) {
        if (!stage) return '';
        return 'stage-' + stage.toLowerCase().replace(/[\s-]+/g, '').replace(/[^a-z]/g, '');
    }

    function esc(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function toggleProject(pid) {
        if (expandedProjects.has(pid)) {
            expandedProjects.delete(pid);
        } else {
            expandedProjects.add(pid);
        }
        renderProjects();
    }

    function toggleExpandAll() {
        if (viewMode === 'bu') {
            // Collect all BU keys
            const buKeys = new Set();
            projects.forEach(p => (p.jobs || []).forEach(j => buKeys.add('bu-' + j.bu_code)));
            const allExpanded = buKeys.size > 0 && [...buKeys].every(k => expandedProjects.has(k));
            if (allExpanded) { expandedProjects.clear(); } else { buKeys.forEach(k => expandedProjects.add(k)); }
            renderProjects();
            const btn = document.getElementById('expandAllBtn');
            const nowExpanded = buKeys.size > 0 && [...buKeys].every(k => expandedProjects.has(k));
            btn.textContent = nowExpanded ? '▼ Collapse All' : '▶ Expand All';
        } else {
            const allExpanded = projects.length > 0 && projects.every(p => expandedProjects.has(p.id));
            if (allExpanded) { expandedProjects.clear(); } else { projects.forEach(p => expandedProjects.add(p.id)); }
            renderProjects();
            const btn = document.getElementById('expandAllBtn');
            const nowExpanded = projects.length > 0 && projects.every(p => expandedProjects.has(p.id));
            btn.textContent = nowExpanded ? '▼ Collapse All' : '▶ Expand All';
        }
    }

    function renderProjects() {
        if (viewMode === 'bu') return renderByBU();
        const container = document.getElementById('projectsTable');
        const stageFilter = document.getElementById('stageFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

        let filtered = projects.map(p => {
            let jobs = p.jobs || [];
            // Stage filter applies at job level
            if (stageFilter) {
                jobs = jobs.filter(j => j.stage === stageFilter);
            }
            // Search matches project name/number/description AND job scope/PM
            if (searchFilter) {
                const projMatch = (p.name && p.name.toLowerCase().includes(searchFilter)) ||
                    (p.number && p.number.toLowerCase().includes(searchFilter)) ||
                    (p.description && p.description.toLowerCase().includes(searchFilter)) ||
                    (p.pm && p.pm.toLowerCase().includes(searchFilter));
                if (!projMatch) {
                    jobs = jobs.filter(j =>
                        (j.scope_name && j.scope_name.toLowerCase().includes(searchFilter)) ||
                        (j.pm && j.pm.toLowerCase().includes(searchFilter)) ||
                        (j.job_code && j.job_code.toLowerCase().includes(searchFilter)) ||
                        (j.bu_name && j.bu_name.toLowerCase().includes(searchFilter))
                    );
                }
            }
            // Show project if it matches or has matching jobs
            if (stageFilter && jobs.length === 0) return null;
            if (searchFilter) {
                const projMatch = (p.name && p.name.toLowerCase().includes(searchFilter)) ||
                    (p.number && p.number.toLowerCase().includes(searchFilter)) ||
                    (p.description && p.description.toLowerCase().includes(searchFilter));
                if (!projMatch && jobs.length === 0) return null;
            }
            return { ...p, filteredJobs: jobs };
        }).filter(Boolean);

        // Sort
        const sortBy = document.getElementById('sortBy').value;
        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'number-asc':  return (a.number || '').localeCompare(b.number || '');
                case 'number-desc': return (b.number || '').localeCompare(a.number || '');
                case 'name-asc':    return (a.name || '').localeCompare(b.name || '');
                case 'name-desc':   return (b.name || '').localeCompare(a.name || '');
                case 'budget-desc': {
                    const ab = (a.jobs||[]).reduce((s,j) => s+(j.allocated_budget||0), 0);
                    const bb = (b.jobs||[]).reduce((s,j) => s+(j.allocated_budget||0), 0);
                    return bb - ab;
                }
                case 'budget-asc': {
                    const ab = (a.jobs||[]).reduce((s,j) => s+(j.allocated_budget||0), 0);
                    const bb = (b.jobs||[]).reduce((s,j) => s+(j.allocated_budget||0), 0);
                    return ab - bb;
                }
                case 'jobs-desc':   return (b.jobs||[]).length - (a.jobs||[]).length;
                case 'location-asc': {
                    const al = [a.city, a.state].filter(Boolean).join(', ');
                    const bl = [b.city, b.state].filter(Boolean).join(', ');
                    return al.localeCompare(bl);
                }
                case 'oldest':      return (a.id || 0) - (b.id || 0);
                case 'newest':
                default:            return (b.id || 0) - (a.id || 0);
            }
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">No projects found. Add your first project to get started!</div>';
            return;
        }

        let html = '<table><thead><tr>';
        html += '<th style="width:30px;"><input type="checkbox" id="selectAllCb" onchange="toggleSelectAll(this)" title="Select all visible jobs"></th>';
        html += '<th>Job</th><th>PM</th><th>Stage</th>';
        html += '<th>Budget</th><th>Weight</th><th>Proj</th><th>GMP</th>';
        html += '<th>Actions</th>';
        html += '</tr></thead><tbody>';

        filtered.forEach(p => {
            // Project budget = sum of job budgets (organizational container)
            const jobs = p.filteredJobs || [];
            const allJobs = p.jobs || [];
            const tb = allJobs.reduce((sum, j) => sum + (j.allocated_budget || 0), 0);
            const expanded = expandedProjects.has(p.id);
            const jobCount = allJobs.length;

            // Project header row
            html += `<tr class="project-header" onclick="toggleProject(${p.id})">`;
            html += `<td></td>`;
            html += `<td colspan="3">`;
            html += `<div class="project-toggle">`;
            html += `<span class="toggle-icon ${expanded ? 'expanded' : ''}">\u25B6</span>`;
            html += `<span class="project-number">${esc(p.number) || '-'}</span>`;
            html += `<span class="project-name">${esc(p.name)}</span>`;
            if ((p.jobs || []).some(j => j.is_gmp)) html += `<span class="gmp-badge">GMP</span>`;
            const loc = [p.city, p.state].filter(Boolean).join(', ');
            if (loc) html += `<span class="project-location">${esc(loc)}</span>`;
            if (p.description) html += `<span class="project-desc">${esc(p.description)}</span>`;
            html += `</div>`;
            html += `</td>`;
            html += `<td class="currency">${tb > 0 ? '$' + tb.toLocaleString() : ''}</td>`;
            html += `<td></td><td></td><td></td>`;
            html += `<td><div class="action-buttons">`;
            html += `<button class="action-btn secondary" onclick="event.stopPropagation();editProject(${p.id})">Edit</button>`;
            if (jobCount > 0) html += `<span class="job-count-badge">${jobCount} job${jobCount > 1 ? 's' : ''}</span>`;
            html += `</div></td>`;
            html += `</tr>`;

            // Job rows (visible when expanded)
            if (expanded) {
                if (jobs.length === 0) {
                    html += `<tr class="no-jobs-row"><td colspan="9">No jobs found for this project</td></tr>`;
                } else {
                    jobs.forEach(j => {
                        const jb = j.allocated_budget || 0;
                        html += `<tr class="job-row">`;
                        // Selection checkbox
                        html += `<td onclick="event.stopPropagation()"><input type="checkbox" class="job-select-cb" data-alloc-id="${j.id}" ${selectedJobs.has(j.id) ? 'checked' : ''} onchange="toggleJobSelect(${j.id},this)"></td>`;
                        // Job code + scope
                        html += `<td><span class="job-code">${esc(j.job_code)}</span>`;
                        if (j.scope_name) html += `<span class="job-scope">- ${esc(j.scope_name)}</span>`;
                        html += `</td>`;
                        // PM
                        html += `<td>${esc(j.pm) || '-'}</td>`;
                        // Stage dropdown
                        html += `<td><select class="stage-select" onchange="updateJobStage(${j.id},this.value)" onclick="event.stopPropagation()">`;
                        STAGES.forEach(s => {
                            html += `<option value="${s}"${j.stage === s ? ' selected' : ''}>${s}</option>`;
                        });
                        html += `</select></td>`;
                        // Budget (inline editable)
                        html += `<td><input type="number" class="budget-input" value="${jb}" step="0.01" min="0" `;
                        html += `onchange="updateJobBudget(${j.id},this.value)" onclick="event.stopPropagation()" `;
                        html += `onfocus="this.select()"></td>`;
                        // Weight slider
                        html += `<td><div class="weight-cell">`;
                        html += `<input type="range" class="weight-slider" min="0" max="2" step="0.1" value="${j.weight_adjustment || 1.0}" `;
                        html += `oninput="this.nextElementSibling.textContent=parseFloat(this.value).toFixed(1)+'x'" `;
                        html += `onchange="updateJobWeight(${j.id},this.value)" onclick="event.stopPropagation()">`;
                        html += `<span class="weight-value">${(j.weight_adjustment || 1.0).toFixed(1)}x</span>`;
                        html += `</div></td>`;
                        // Projection toggle
                        html += `<td><input type="checkbox" class="projection-toggle" ${j.projection_enabled ? 'checked' : ''} `;
                        html += `onchange="updateJobProjection(${j.id},this.checked)" onclick="event.stopPropagation()" title="Include in projections"></td>`;
                        // GMP toggle
                        html += `<td><input type="checkbox" class="projection-toggle" ${j.is_gmp ? 'checked' : ''} `;
                        html += `onchange="updateJobGmp(${j.id},this.checked)" onclick="event.stopPropagation()" title="GMP contract"></td>`;
                        // Actions (empty — delete moved to edit page)
                        html += `<td></td>`;
                        html += `</tr>`;
                    });
                }
            }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        updateBulkToolbar();
    }

    function renderByBU() {
        const container = document.getElementById('projectsTable');
        const stageFilter = document.getElementById('stageFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

        // Collect all jobs across all projects, attach parent project info
        let allJobs = [];
        projects.forEach(p => {
            (p.jobs || []).forEach(j => {
                allJobs.push({ ...j, project_name: p.name, project_number: p.number, project_id: p.id, project_city: p.city, project_state: p.state, is_gmp: p.is_gmp });
            });
        });

        // Apply filters
        if (stageFilter) allJobs = allJobs.filter(j => j.stage === stageFilter);
        if (searchFilter) {
            allJobs = allJobs.filter(j =>
                (j.job_code && j.job_code.toLowerCase().includes(searchFilter)) ||
                (j.scope_name && j.scope_name.toLowerCase().includes(searchFilter)) ||
                (j.pm && j.pm.toLowerCase().includes(searchFilter)) ||
                (j.bu_name && j.bu_name.toLowerCase().includes(searchFilter)) ||
                (j.project_name && j.project_name.toLowerCase().includes(searchFilter)) ||
                (j.project_number && j.project_number.toLowerCase().includes(searchFilter))
            );
        }

        // Group by BU code
        const buMap = {};
        allJobs.forEach(j => {
            const key = j.bu_code || '???';
            if (!buMap[key]) buMap[key] = { code: j.bu_code, name: j.bu_name, jobs: [] };
            buMap[key].jobs.push(j);
        });

        // Sort jobs within each BU group based on dropdown
        const sortBy = document.getElementById('sortBy').value;
        function sortJobs(jobs) {
            return jobs.sort((a, b) => {
                switch (sortBy) {
                    case 'number-asc':  return (a.job_code || '').localeCompare(b.job_code || '');
                    case 'number-desc': return (b.job_code || '').localeCompare(a.job_code || '');
                    case 'name-asc':    return (a.project_name || '').localeCompare(b.project_name || '');
                    case 'name-desc':   return (b.project_name || '').localeCompare(a.project_name || '');
                    case 'budget-desc': return (b.allocated_budget || 0) - (a.allocated_budget || 0);
                    case 'budget-asc':  return (a.allocated_budget || 0) - (b.allocated_budget || 0);
                    case 'location-asc': {
                        const al = [a.project_city, a.project_state].filter(Boolean).join(', ');
                        const bl = [b.project_city, b.project_state].filter(Boolean).join(', ');
                        return al.localeCompare(bl);
                    }
                    case 'oldest':      return (a.id || 0) - (b.id || 0);
                    case 'newest':
                    default:            return (b.id || 0) - (a.id || 0);
                }
            });
        }
        Object.values(buMap).forEach(bu => sortJobs(bu.jobs));

        // Sort BU groups (by job count for 'jobs-desc', otherwise by code)
        const buGroups = Object.values(buMap).sort((a, b) => {
            if (sortBy === 'jobs-desc') return b.jobs.length - a.jobs.length;
            return (a.code || '').localeCompare(b.code || '');
        });

        if (buGroups.length === 0) {
            container.innerHTML = '<div class="empty-state">No jobs found matching filters.</div>';
            return;
        }

        let html = '<table><thead><tr>';
        html += '<th style="width:30px;"><input type="checkbox" id="selectAllCb" onchange="toggleSelectAll(this)" title="Select all visible jobs"></th>';
        html += '<th>Job</th><th>Project</th><th>Stage</th>';
        html += '<th>Budget</th><th>Weight</th><th>Proj</th><th>GMP</th>';
        html += '<th>Actions</th>';
        html += '</tr></thead><tbody>';

        buGroups.forEach(bu => {
            const buKey = 'bu-' + bu.code;
            const expanded = expandedProjects.has(buKey);
            const tb = bu.jobs.reduce((sum, j) => sum + (j.allocated_budget || 0), 0);
            const jobCount = bu.jobs.length;

            // BU header row
            html += `<tr class="project-header" onclick="toggleProject('${buKey}')">`;
            html += `<td></td>`;
            html += `<td colspan="3">`;
            html += `<div class="project-toggle">`;
            html += `<span class="toggle-icon ${expanded ? 'expanded' : ''}">\u25B6</span>`;
            html += `<span class="project-number">${esc(bu.code)}</span>`;
            html += `<span class="project-name">${esc(bu.name)}</span>`;
            html += `</div>`;
            html += `</td>`;
            html += `<td class="currency">${tb > 0 ? '$' + tb.toLocaleString() : ''}</td>`;
            html += `<td></td><td></td><td></td>`;
            html += `<td><div class="action-buttons">`;
            if (jobCount > 0) html += `<span class="job-count-badge">${jobCount} job${jobCount > 1 ? 's' : ''}</span>`;
            html += `</div></td>`;
            html += `</tr>`;

            if (expanded) {
                bu.jobs.forEach(j => {
                    const jb = j.allocated_budget || 0;
                    html += `<tr class="job-row">`;
                    // Selection checkbox
                    html += `<td onclick="event.stopPropagation()"><input type="checkbox" class="job-select-cb" data-alloc-id="${j.id}" ${selectedJobs.has(j.id) ? 'checked' : ''} onchange="toggleJobSelect(${j.id},this)"></td>`;
                    // Job code + scope
                    html += `<td><span class="job-code">${esc(j.job_code)}</span>`;
                    if (j.scope_name) html += `<span class="job-scope">- ${esc(j.scope_name)}</span>`;
                    html += `</td>`;
                    // Project name + number
                    html += `<td><span class="job-code">${esc(j.project_number)}</span> <span style="color:var(--color-text-muted)">${esc(j.project_name)}</span></td>`;
                    // Stage dropdown
                    html += `<td><select class="stage-select" onchange="updateJobStage(${j.id},this.value)" onclick="event.stopPropagation()">`;
                    STAGES.forEach(s => {
                        html += `<option value="${s}"${j.stage === s ? ' selected' : ''}>${s}</option>`;
                    });
                    html += `</select></td>`;
                    // Budget
                    html += `<td><input type="number" class="budget-input" value="${jb}" step="0.01" min="0" `;
                    html += `onchange="updateJobBudget(${j.id},this.value)" onclick="event.stopPropagation()" `;
                    html += `onfocus="this.select()"></td>`;
                    // Weight slider
                    html += `<td><div class="weight-cell">`;
                    html += `<input type="range" class="weight-slider" min="0" max="2" step="0.1" value="${j.weight_adjustment || 1.0}" `;
                    html += `oninput="this.nextElementSibling.textContent=parseFloat(this.value).toFixed(1)+'x'" `;
                    html += `onchange="updateJobWeight(${j.id},this.value)" onclick="event.stopPropagation()">`;
                    html += `<span class="weight-value">${(j.weight_adjustment || 1.0).toFixed(1)}x</span>`;
                    html += `</div></td>`;
                    // Projection toggle
                    html += `<td><input type="checkbox" class="projection-toggle" ${j.projection_enabled ? 'checked' : ''} `;
                    html += `onchange="updateJobProjection(${j.id},this.checked)" onclick="event.stopPropagation()" title="Include in projections"></td>`;
                    // GMP toggle
                    html += `<td><input type="checkbox" class="projection-toggle" ${j.is_gmp ? 'checked' : ''} `;
                    html += `onchange="updateJobGmp(${j.id},this.checked)" onclick="event.stopPropagation()" title="GMP contract"></td>`;
                    // Actions
                    html += `<td></td>`;
                    html += `</tr>`;
                });
            }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        updateBulkToolbar();
    }

    // Inline edit handlers — update local data after PATCH so re-renders stay in sync
    function _findJob(allocId) {
        for (const p of projects) {
            const job = (p.jobs || []).find(j => j.id === allocId);
            if (job) return job;
        }
        return null;
    }

    async function updateJobWeight(allocId, value) {
        try {
            const res = await fetch(`${API_BASE}/allocations/${allocId}/weight`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ weight: parseFloat(value) })
            });
            if (res.ok) { const j = _findJob(allocId); if (j) j.weight_adjustment = parseFloat(value); }
        } catch (error) { showError('Failed to update weight'); }
    }

    async function updateJobProjection(allocId, enabled) {
        try {
            const res = await fetch(`${API_BASE}/allocations/${allocId}/projection`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });
            if (res.ok) { const j = _findJob(allocId); if (j) j.projection_enabled = enabled ? 1 : 0; }
        } catch (error) { showError('Failed to update projection flag'); }
    }

    async function updateJobGmp(allocId, isGmp) {
        try {
            const res = await fetch(`${API_BASE}/allocations/${allocId}/gmp`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isGmp })
            });
            if (res.ok) { const j = _findJob(allocId); if (j) j.is_gmp = isGmp ? 1 : 0; }
        } catch (error) { showError('Failed to update GMP flag'); }
    }

    async function updateJobStage(allocId, stage) {
        try {
            const res = await fetch(`${API_BASE}/allocations/${allocId}/stage`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stage })
            });
            if (res.ok) { const j = _findJob(allocId); if (j) j.stage = stage; }
        } catch (error) { showError('Failed to update stage'); }
    }

    async function updateJobBudget(allocId, value) {
        try {
            const response = await fetch(`${API_BASE}/allocations/${allocId}/budget`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ budget: parseFloat(value) || 0 })
            });
            if (response.ok) loadProjects(); // refresh rollup totals
        } catch (error) { showError('Failed to update budget'); }
    }

    function downloadTemplate() {
        window.location.href = `${API_BASE}/projects/template`;
    }

    async function importProjects(file) {
        if (!file) return;
        const resultsContainer = document.getElementById('importResults');
        resultsContainer.innerHTML = '<div class="loading">Importing projects...</div>';
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch(`${API_BASE}/projects/import`, { method: 'POST', body: formData });
            const result = await response.json();
            if (response.ok) {
                displayImportResults(result);
                if (result.success_count > 0) loadProjects();
            } else {
                resultsContainer.innerHTML = `<div class="error-message" style="display:block;">${result.error}</div>`;
            }
        } catch (error) {
            resultsContainer.innerHTML = '<div class="error-message" style="display:block;">Failed to import projects.</div>';
        }
        document.getElementById('importFile').value = '';
    }

    async function importProcore(file) {
        if (!file) return;
        const resultsContainer = document.getElementById('importResults');
        resultsContainer.innerHTML = '<div class="loading">Importing from Procore...</div>';
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch(`${API_BASE}/projects/import-procore`, { method: 'POST', body: formData });
            const result = await response.json();
            if (response.ok) {
                displayProcoreResults(result);
                if (result.projects_created > 0 || result.projects_updated > 0) loadProjects();
            } else {
                resultsContainer.innerHTML = `<div class="error-message" style="display:block;">${result.error}</div>`;
            }
        } catch (error) {
            resultsContainer.innerHTML = '<div class="error-message" style="display:block;">Failed to import from Procore.</div>';
        }
        document.getElementById('procoreFile').value = '';
    }

    function displayProcoreResults(result) {
        const container = document.getElementById('importResults');
        let html = '';
        const total = result.projects_created + result.projects_updated;
        if (total > 0) {
            html += `<div class="success-message" style="display:block;margin-bottom:10px;">`;
            html += `${result.projects_created} project(s) created, ${result.projects_updated} updated. `;
            html += `${result.jobs_created} job(s) created, ${result.jobs_updated} updated.`;
            html += `</div>`;
        }
        if (result.rows_skipped > 0) {
            html += `<div style="color:var(--color-text-muted);margin-bottom:10px;font-size:13px;">${result.rows_skipped} row(s) skipped.</div>`;
        }
        if (result.errors && result.errors.length > 0) {
            html += `<div class="error-message" style="display:block;margin-bottom:10px;">${result.errors.length} error(s) during import.</div>`;
            html += '<table style="margin-top:10px;font-size:13px;"><thead><tr><th>Row</th><th>Project</th><th>Error</th></tr></thead><tbody>';
            result.errors.forEach(err => {
                html += `<tr><td>${err.row}</td><td>${err.name}</td><td style="color:var(--color-danger);">${err.errors.join('; ')}</td></tr>`;
            });
            html += '</tbody></table>';
        }
        container.innerHTML = html;
    }

    function displayImportResults(result) {
        const container = document.getElementById('importResults');
        let html = '';
        if (result.success_count > 0) {
            html += `<div class="success-message" style="display:block;margin-bottom:10px;">${result.success_count} project${result.success_count > 1 ? 's' : ''} imported successfully!</div>`;
        }
        if (result.errors && result.errors.length > 0) {
            html += `<div class="error-message" style="display:block;margin-bottom:10px;">${result.errors.length} row${result.errors.length > 1 ? 's' : ''} had errors.</div>`;
            html += '<table style="margin-top:10px;font-size:13px;"><thead><tr><th>Row</th><th>Project</th><th>Error</th></tr></thead><tbody>';
            result.errors.forEach(err => {
                html += `<tr><td>${err.row}</td><td>${err.project_name}</td><td style="color:var(--color-danger);">${err.errors.join('; ')}</td></tr>`;
            });
            html += '</tbody></table>';
        }
        container.innerHTML = html;
    }

    function showSuccess(msg) {
        const modalOpen = document.getElementById('projectModal').style.display === 'flex';
        const el = document.getElementById(modalOpen ? 'successMessage' : 'pageSuccessMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function showError(msg) {
        const modalOpen = document.getElementById('projectModal').style.display === 'flex';
        const el = document.getElementById(modalOpen ? 'errorMessage' : 'pageErrorMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('projectModal').style.display === 'flex') {
            closeProjectModal();
        }
    });

    // Close modal on overlay click
    document.getElementById('projectModal').addEventListener('click', function(e) {
        if (e.target === this) closeProjectModal();
    });

    if (window.location.hash === '#import') {
        document.getElementById('importSection').style.display = 'block';
    }

    loadBusinessUnits();
    loadProjects();
</script>
{% endblock %}
