{% extends "base.html" %}

{% block title %}Projects - QMS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Projects</h1>
    <p class="subtitle">Manage projects and budgets</p>
</div>

<div class="main-grid">
    <div class="card">
        <h2 id="formTitle">Add New Project</h2>
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        <form id="projectForm">
            <div class="form-group">
                <label>Project Name *</label>
                <input type="text" id="projectName" required>
            </div>
            <div class="form-group">
                <label>Project Number *</label>
                <div style="display:grid;grid-template-columns:1fr auto 1fr auto 1fr;gap:10px;align-items:center;">
                    <input type="text" id="projectBase" pattern="\d{5}" placeholder="06974" maxlength="5" required style="text-align:center;">
                    <span style="font-weight:bold;color:#7f8c8d;">-</span>
                    <select id="projectBU" required style="text-align:left;">
                        <option value="">BU</option>
                    </select>
                    <span style="font-weight:bold;color:#7f8c8d;">-</span>
                    <input type="text" id="projectSubjob" pattern="\d{2}" placeholder="01" maxlength="2" required style="text-align:center;">
                </div>
                <input type="hidden" id="projectCode">
                <div class="help-text">Format: NNNNN-CCC-SS (e.g., 06974-230-01)</div>
            </div>
            <div class="form-group">
                <label>Project Manager</label>
                <input type="text" id="projectManager">
            </div>
            <div class="form-group">
                <label>Stage *</label>
                <select id="projectStage" required>
                    {% for stage in stages %}
                    <option value="{{ stage }}">{{ stage }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Total Budget *</label>
                <input type="number" id="totalBudget" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Manual Weight Adjustment</label>
                <input type="number" id="weightAdjustment" step="0.1" value="1.0" min="0.5" max="2.0">
                <div class="help-text">Default: 1.0 (Range: 0.5 - 2.0)</div>
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="endDate">
            </div>

            <h3 style="margin-top:25px;padding-top:15px;border-top:1px solid #ecf0f1;">Owner Information</h3>
            <div class="form-group">
                <label>Owner Name</label>
                <input type="text" id="ownerName">
            </div>
            <div class="form-group">
                <label>Address</label>
                <input type="text" id="ownerAddress">
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" id="ownerCity">
            </div>
            <div class="form-group">
                <label>State</label>
                <select id="ownerState">
                    <option value="">Select State</option>
                    <option value="AL">AL - Alabama</option><option value="AK">AK - Alaska</option>
                    <option value="AZ">AZ - Arizona</option><option value="AR">AR - Arkansas</option>
                    <option value="CA">CA - California</option><option value="CO">CO - Colorado</option>
                    <option value="CT">CT - Connecticut</option><option value="DE">DE - Delaware</option>
                    <option value="FL">FL - Florida</option><option value="GA">GA - Georgia</option>
                    <option value="HI">HI - Hawaii</option><option value="ID">ID - Idaho</option>
                    <option value="IL">IL - Illinois</option><option value="IN">IN - Indiana</option>
                    <option value="IA">IA - Iowa</option><option value="KS">KS - Kansas</option>
                    <option value="KY">KY - Kentucky</option><option value="LA">LA - Louisiana</option>
                    <option value="ME">ME - Maine</option><option value="MD">MD - Maryland</option>
                    <option value="MA">MA - Massachusetts</option><option value="MI">MI - Michigan</option>
                    <option value="MN">MN - Minnesota</option><option value="MS">MS - Mississippi</option>
                    <option value="MO">MO - Missouri</option><option value="MT">MT - Montana</option>
                    <option value="NE">NE - Nebraska</option><option value="NV">NV - Nevada</option>
                    <option value="NH">NH - New Hampshire</option><option value="NJ">NJ - New Jersey</option>
                    <option value="NM">NM - New Mexico</option><option value="NY">NY - New York</option>
                    <option value="NC">NC - North Carolina</option><option value="ND">ND - North Dakota</option>
                    <option value="OH">OH - Ohio</option><option value="OK">OK - Oklahoma</option>
                    <option value="OR">OR - Oregon</option><option value="PA">PA - Pennsylvania</option>
                    <option value="RI">RI - Rhode Island</option><option value="SC">SC - South Carolina</option>
                    <option value="SD">SD - South Dakota</option><option value="TN">TN - Tennessee</option>
                    <option value="TX">TX - Texas</option><option value="UT">UT - Utah</option>
                    <option value="VT">VT - Vermont</option><option value="VA">VA - Virginia</option>
                    <option value="WA">WA - Washington</option><option value="WV">WV - West Virginia</option>
                    <option value="WI">WI - Wisconsin</option><option value="WY">WY - Wyoming</option>
                </select>
            </div>
            <div class="form-group">
                <label>Zip Code</label>
                <input type="text" id="ownerZip" maxlength="10" placeholder="12345">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="notes"></textarea>
            </div>
            <button type="submit" id="submitBtn">Add Project</button>
            <button type="button" class="secondary" onclick="resetForm()">Clear</button>
        </form>

        <div class="import-section" id="import">
            <h3>Bulk Import</h3>
            <p style="color:#7f8c8d;margin-bottom:10px;font-size:13px;">Import multiple projects from an Excel file</p>
            <div class="import-buttons">
                <button onclick="downloadTemplate()">Download Template</button>
                <input type="file" id="importFile" accept=".xlsx" style="display:none;" onchange="importProjects(this.files[0])">
                <button class="success" onclick="document.getElementById('importFile').click()">Import Projects</button>
            </div>
            <div id="importResults" style="margin-top:15px;"></div>
        </div>
    </div>

    <div class="card">
        <h2>All Projects</h2>
        <div class="filter-bar">
            <select id="stageFilter" onchange="renderProjects()">
                <option value="">All Stages</option>
                {% for stage in stages %}
                <option value="{{ stage }}">{{ stage }}</option>
                {% endfor %}
            </select>
            <input type="text" id="searchFilter" placeholder="Search projects..." oninput="renderProjects()">
        </div>
        <div id="projectsTable"><div class="loading">Loading projects...</div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let projects = [];
    let businessUnits = [];
    let currentEditId = null;
    const API_BASE = '/projects/api';

    function updateProjectCode() {
        const base = document.getElementById('projectBase').value;
        const bu = document.getElementById('projectBU').value;
        const subjob = document.getElementById('projectSubjob').value;
        if (base && bu && subjob) {
            document.getElementById('projectCode').value = `${base}-${bu}-${subjob}`;
        }
    }

    document.getElementById('projectBase').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        updateProjectCode();
    });
    document.getElementById('projectBU').addEventListener('change', updateProjectCode);
    document.getElementById('projectSubjob').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        updateProjectCode();
    });

    async function loadBusinessUnits() {
        try {
            const response = await fetch(`${API_BASE}/business-units`);
            businessUnits = await response.json();
            populateBUDropdown();
        } catch (error) {
            console.error('Error loading business units:', error);
        }
    }

    function populateBUDropdown() {
        const select = document.getElementById('projectBU');
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select BU</option>';
        businessUnits.forEach(bu => {
            const option = document.createElement('option');
            option.value = bu.code;
            option.textContent = `${bu.code} - ${bu.name}`;
            select.appendChild(option);
        });
        if (currentValue) select.value = currentValue;
    }

    document.getElementById('projectForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const projectData = {
            name: document.getElementById('projectName').value,
            code: document.getElementById('projectCode').value,
            manager: document.getElementById('projectManager').value,
            stage: document.getElementById('projectStage').value,
            totalBudget: parseFloat(document.getElementById('totalBudget').value),
            weightAdjustment: parseFloat(document.getElementById('weightAdjustment').value) || 1.0,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            ownerName: document.getElementById('ownerName').value,
            ownerAddress: document.getElementById('ownerAddress').value,
            ownerCity: document.getElementById('ownerCity').value,
            ownerState: document.getElementById('ownerState').value,
            ownerZip: document.getElementById('ownerZip').value,
            notes: document.getElementById('notes').value
        };

        try {
            const url = currentEditId
                ? `${API_BASE}/projects/${currentEditId}`
                : `${API_BASE}/projects`;
            const method = currentEditId ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method, headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectData)
            });
            const result = await response.json();
            if (response.ok) {
                showSuccess(currentEditId ? 'Project updated!' : 'Project added!');
                resetForm();
                loadProjects();
            } else {
                showError(result.error || 'Failed to save project');
            }
        } catch (error) {
            console.error('Error saving project:', error);
            showError('Failed to save project');
        }
    });

    function resetForm() {
        document.getElementById('projectForm').reset();
        document.getElementById('projectBase').value = '';
        document.getElementById('projectBU').value = '';
        document.getElementById('projectSubjob').value = '';
        document.getElementById('projectCode').value = '';
        document.getElementById('weightAdjustment').value = '1.0';
        document.getElementById('ownerName').value = '';
        document.getElementById('ownerAddress').value = '';
        document.getElementById('ownerCity').value = '';
        document.getElementById('ownerState').value = '';
        document.getElementById('ownerZip').value = '';
        currentEditId = null;
        document.getElementById('submitBtn').textContent = 'Add Project';
        document.getElementById('formTitle').textContent = 'Add New Project';
    }

    function editProject(id) {
        const project = projects.find(p => p.id === id);
        if (!project) return;
        document.getElementById('projectName').value = project.name;
        const codeParts = (project.code || '').split('-');
        if (codeParts.length === 3) {
            document.getElementById('projectBase').value = codeParts[0];
            document.getElementById('projectBU').value = codeParts[1];
            document.getElementById('projectSubjob').value = codeParts[2];
            document.getElementById('projectCode').value = project.code;
        }
        document.getElementById('projectManager').value = project.manager || '';
        document.getElementById('projectStage').value = project.stage;
        document.getElementById('totalBudget').value = project.total_budget;
        document.getElementById('weightAdjustment').value = project.weight_adjustment;
        document.getElementById('startDate').value = project.start_date || '';
        document.getElementById('endDate').value = project.end_date || '';
        document.getElementById('ownerName').value = project.owner_name || '';
        document.getElementById('ownerAddress').value = project.owner_address || '';
        document.getElementById('ownerCity').value = project.owner_city || '';
        document.getElementById('ownerState').value = project.owner_state || '';
        document.getElementById('ownerZip').value = project.owner_zip || '';
        document.getElementById('notes').value = project.notes || '';
        currentEditId = id;
        document.getElementById('submitBtn').textContent = 'Update Project';
        document.getElementById('formTitle').textContent = 'Edit Project';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteProject(id) {
        if (!confirm('Are you sure you want to delete this project?')) return;
        try {
            const response = await fetch(`${API_BASE}/projects/${id}`, { method: 'DELETE' });
            if (response.ok) { showSuccess('Project deleted!'); loadProjects(); }
            else showError('Failed to delete project');
        } catch (error) { showError('Failed to delete project'); }
    }

    async function loadProjects() {
        try {
            const response = await fetch(`${API_BASE}/projects`);
            projects = await response.json();
            renderProjects();
        } catch (error) { showError('Failed to load projects'); }
    }

    function getStageClass(stage) {
        return 'stage-' + stage.toLowerCase().replace(/[\s-]+/g, '').replace(/[^a-z]/g, '');
    }

    function renderProjects() {
        const container = document.getElementById('projectsTable');
        const stageFilter = document.getElementById('stageFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
        let filtered = projects;
        if (stageFilter) filtered = filtered.filter(p => p.stage === stageFilter);
        if (searchFilter) filtered = filtered.filter(p =>
            p.name.toLowerCase().includes(searchFilter) ||
            (p.code && p.code.toLowerCase().includes(searchFilter)) ||
            (p.manager && p.manager.toLowerCase().includes(searchFilter))
        );
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">No projects found. Add your first project to get started!</div>';
            return;
        }
        let html = '<table><thead><tr><th>Project Name</th><th>Number</th><th>PM</th><th>Stage</th><th>Budget</th><th>Spent</th><th>Remaining</th><th>Weight</th><th>Actions</th></tr></thead><tbody>';
        filtered.forEach(p => {
            const remaining = p.total_budget - p.budget_spent;
            const pct = p.total_budget > 0 ? (p.budget_spent / p.total_budget) * 100 : 0;
            const barClass = pct > 90 ? 'danger' : pct > 70 ? 'warning' : '';
            html += '<tr>';
            html += `<td><strong>${p.name}</strong></td>`;
            html += `<td>${p.code || '-'}</td>`;
            html += `<td>${p.manager || '-'}</td>`;
            html += `<td><span class="status-badge ${getStageClass(p.stage)}">${p.stage}</span></td>`;
            html += `<td class="currency">$${p.total_budget.toLocaleString()}</td>`;
            html += `<td>$${p.budget_spent.toLocaleString()}<div class="budget-bar"><div class="budget-fill ${barClass}" style="width:${pct}%"></div></div></td>`;
            html += `<td class="currency">$${remaining.toLocaleString()}</td>`;
            html += `<td>${p.weight_adjustment}x</td>`;
            html += `<td><div class="action-buttons">`;
            html += `<button class="action-btn secondary" onclick="editProject(${p.id})">Edit</button>`;
            html += `<button class="action-btn danger" onclick="deleteProject(${p.id})">Delete</button>`;
            html += `</div></td></tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function downloadTemplate() {
        window.location.href = `${API_BASE}/projects/template`;
    }

    async function importProjects(file) {
        if (!file) return;
        const resultsContainer = document.getElementById('importResults');
        resultsContainer.innerHTML = '<div class="loading">Importing projects...</div>';
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch(`${API_BASE}/projects/import`, { method: 'POST', body: formData });
            const result = await response.json();
            if (response.ok) {
                displayImportResults(result);
                if (result.success_count > 0) loadProjects();
            } else {
                resultsContainer.innerHTML = `<div class="error-message" style="display:block;">${result.error}</div>`;
            }
        } catch (error) {
            resultsContainer.innerHTML = '<div class="error-message" style="display:block;">Failed to import projects.</div>';
        }
        document.getElementById('importFile').value = '';
    }

    function displayImportResults(result) {
        const container = document.getElementById('importResults');
        let html = '';
        if (result.success_count > 0) {
            html += `<div class="success-message" style="display:block;margin-bottom:10px;">${result.success_count} project${result.success_count > 1 ? 's' : ''} imported successfully!</div>`;
        }
        if (result.errors && result.errors.length > 0) {
            html += `<div class="error-message" style="display:block;margin-bottom:10px;">${result.errors.length} row${result.errors.length > 1 ? 's' : ''} had errors.</div>`;
            html += '<table style="margin-top:10px;font-size:13px;"><thead><tr><th>Row</th><th>Project</th><th>Error</th></tr></thead><tbody>';
            result.errors.forEach(err => {
                html += `<tr><td>${err.row}</td><td>${err.project_name}</td><td style="color:#e74c3c;">${err.errors.join('; ')}</td></tr>`;
            });
            html += '</tbody></table>';
        }
        container.innerHTML = html;
    }

    function showSuccess(msg) {
        const el = document.getElementById('successMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function showError(msg) {
        const el = document.getElementById('errorMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    if (window.location.hash === '#import') {
        setTimeout(() => document.getElementById('import').scrollIntoView({ behavior: 'smooth' }), 100);
    }

    loadBusinessUnits();
    loadProjects();
</script>
{% endblock %}
