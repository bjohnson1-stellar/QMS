{% extends "base.html" %}

{% block title %}Settings - QMS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
    <p class="subtitle">Application configuration</p>
</div>

<div class="card" style="max-width:600px;">
    <h2>Application Settings</h2>

    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>

    <form id="settingsForm">
        <div class="form-group">
            <label for="companyName">Company Name</label>
            <input type="text" id="companyName" required>
        </div>

        <div class="form-group">
            <label for="defaultHourlyRate">Default Hourly Rate</label>
            <div class="input-prefix">
                <input type="number" id="defaultHourlyRate" step="0.01" min="0.01" required>
            </div>
            <div class="help-text">Used for calculating projected costs in time allocations</div>
        </div>

        <div class="form-group">
            <label for="workingHoursPerMonth">Working Hours Per Month</label>
            <input type="number" id="workingHoursPerMonth" min="1" max="300" required>
            <div class="help-text">Typical full-time is 176 hours (22 days x 8 hours)</div>
        </div>

        <div class="form-group">
            <label for="fiscalYearStartMonth">Fiscal Year Start Month</label>
            <select id="fiscalYearStartMonth" required>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>

        <div class="form-group">
            <label for="gmpWeightMultiplier">GMP Weight Multiplier</label>
            <input type="number" id="gmpWeightMultiplier" step="0.1" min="1.0" max="5.0" required>
            <div class="help-text">Applied to GMP projects in projections (default: 1.5x)</div>
        </div>

        <button type="submit">Save Settings</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/projects/api';

    async function loadSettings() {
        try {
            const response = await fetch(`${API_BASE}/settings`);
            const settings = await response.json();
            document.getElementById('companyName').value = settings.company_name || '';
            document.getElementById('defaultHourlyRate').value = settings.default_hourly_rate || 150;
            document.getElementById('workingHoursPerMonth').value = settings.working_hours_per_month || 176;
            document.getElementById('fiscalYearStartMonth').value = settings.fiscal_year_start_month || 1;
            document.getElementById('gmpWeightMultiplier').value = settings.gmp_weight_multiplier || 1.5;
        } catch (error) { showError('Failed to load settings'); }
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            companyName: document.getElementById('companyName').value,
            defaultHourlyRate: parseFloat(document.getElementById('defaultHourlyRate').value),
            workingHoursPerMonth: parseInt(document.getElementById('workingHoursPerMonth').value),
            fiscalYearStartMonth: parseInt(document.getElementById('fiscalYearStartMonth').value),
            gmpWeightMultiplier: parseFloat(document.getElementById('gmpWeightMultiplier').value)
        };
        try {
            const response = await fetch(`${API_BASE}/settings`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) showSuccess('Settings saved successfully!');
            else {
                const error = await response.json();
                showError(error.error || 'Failed to save settings');
            }
        } catch (error) { showError('Failed to save settings'); }
    });

    function showSuccess(msg) {
        const el = document.getElementById('successMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function showError(msg) {
        const el = document.getElementById('errorMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    loadSettings();
</script>
{% endblock %}
