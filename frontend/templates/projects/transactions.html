{% extends "base.html" %}

{% block title %}Transactions - QMS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Transactions</h1>
    <p class="subtitle">Track project spending</p>
</div>

<div class="main-grid">
    <div class="card">
        <h2 id="formTitle">Add Transaction</h2>
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
        <form id="transactionForm">
            <div class="form-group">
                <label>Project *</label>
                <select id="projectId" required>
                    <option value="">Select Project</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date *</label>
                <input type="date" id="transactionDate" required>
            </div>
            <div class="form-group">
                <label>Type *</label>
                <select id="transactionType" required onchange="toggleTimeFields()">
                    <option value="">Select Type</option>
                    <option value="Time">Time</option>
                    <option value="Travel">Travel</option>
                    <option value="Materials">Materials</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <input type="text" id="description" required placeholder="Brief description of the transaction">
            </div>

            <div id="timeFieldsContainer" style="display:none;">
                <div class="time-fields">
                    <div class="form-group">
                        <label>Hours *</label>
                        <input type="number" id="hours" step="0.25" min="0" placeholder="0.00" oninput="calculateAmount()">
                    </div>
                    <div class="form-group">
                        <label>Rate ($/hr) *</label>
                        <input type="number" id="rate" step="0.01" min="0" placeholder="0.00" oninput="calculateAmount()">
                    </div>
                </div>
                <div class="calculated-amount">
                    Calculated Amount: <span id="calculatedAmount">$0.00</span>
                </div>
            </div>

            <div id="amountFieldContainer" class="form-group">
                <label>Amount *</label>
                <input type="number" id="amount" step="0.01" min="0" placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="notes" placeholder="Additional notes (optional)"></textarea>
            </div>

            <button type="submit" id="submitBtn">Add Transaction</button>
            <button type="button" class="secondary" onclick="resetForm()">Clear</button>
        </form>
    </div>

    <div class="card">
        <h2>Transaction Ledger</h2>
        <div class="filter-bar">
            <select id="filterProject" onchange="loadTransactions()">
                <option value="">All Projects</option>
            </select>
            <select id="filterType" onchange="loadTransactions()">
                <option value="">All Types</option>
                <option value="Time">Time</option>
                <option value="Travel">Travel</option>
                <option value="Materials">Materials</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div id="transactionsTable"><div class="loading">Loading transactions...</div></div>
        <div id="totalAmount" style="margin-top:15px;padding-top:15px;border-top:2px solid var(--color-border-light);text-align:right;font-weight:bold;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let transactions = [];
    let projects = [];
    let currentEditId = null;
    const API_BASE = '/projects/api';

    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];

    async function loadProjects() {
        try {
            const response = await fetch(`${API_BASE}/projects`);
            projects = await response.json();
            populateProjectDropdowns();
        } catch (error) { console.error('Error loading projects:', error); }
    }

    function populateProjectDropdowns() {
        const formSelect = document.getElementById('projectId');
        const filterSelect = document.getElementById('filterProject');
        const currentFormValue = formSelect.value;
        const currentFilterValue = filterSelect.value;
        formSelect.innerHTML = '<option value="">Select Project</option>';
        filterSelect.innerHTML = '<option value="">All Projects</option>';
        projects.forEach(p => {
            formSelect.appendChild(new Option(`${p.code} - ${p.name}`, p.id));
            filterSelect.appendChild(new Option(`${p.code} - ${p.name}`, p.id));
        });
        if (currentFormValue) formSelect.value = currentFormValue;
        if (currentFilterValue) filterSelect.value = currentFilterValue;
    }

    function toggleTimeFields() {
        const type = document.getElementById('transactionType').value;
        const timeContainer = document.getElementById('timeFieldsContainer');
        const amountContainer = document.getElementById('amountFieldContainer');
        if (type === 'Time') {
            timeContainer.style.display = 'block';
            amountContainer.style.display = 'none';
            document.getElementById('amount').removeAttribute('required');
            document.getElementById('hours').setAttribute('required', 'required');
            document.getElementById('rate').setAttribute('required', 'required');
        } else {
            timeContainer.style.display = 'none';
            amountContainer.style.display = 'block';
            document.getElementById('amount').setAttribute('required', 'required');
            document.getElementById('hours').removeAttribute('required');
            document.getElementById('rate').removeAttribute('required');
        }
    }

    function calculateAmount() {
        const hours = parseFloat(document.getElementById('hours').value) || 0;
        const rate = parseFloat(document.getElementById('rate').value) || 0;
        document.getElementById('calculatedAmount').textContent = '$' + (hours * rate).toFixed(2);
    }

    document.getElementById('transactionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const type = document.getElementById('transactionType').value;
        let amount = parseFloat(document.getElementById('amount').value) || 0;
        const hours = parseFloat(document.getElementById('hours').value) || null;
        const rate = parseFloat(document.getElementById('rate').value) || null;
        if (type === 'Time' && hours && rate) amount = hours * rate;

        const data = {
            projectId: document.getElementById('projectId').value,
            transactionDate: document.getElementById('transactionDate').value,
            transactionType: type,
            description: document.getElementById('description').value,
            amount, hours, rate,
            notes: document.getElementById('notes').value
        };

        try {
            const url = currentEditId ? `${API_BASE}/transactions/${currentEditId}` : `${API_BASE}/transactions`;
            const method = currentEditId ? 'PUT' : 'POST';
            const response = await fetch(url, {
                method, headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
                showSuccess(currentEditId ? 'Transaction updated!' : 'Transaction added!');
                resetForm();
                loadTransactions();
            } else showError(result.error || 'Failed to save transaction');
        } catch (error) { showError('Failed to save transaction: ' + error.message); }
    });

    function resetForm() {
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('calculatedAmount').textContent = '$0.00';
        toggleTimeFields();
        currentEditId = null;
        document.getElementById('submitBtn').textContent = 'Add Transaction';
        document.getElementById('formTitle').textContent = 'Add Transaction';
    }

    function editTransaction(id) {
        const trans = transactions.find(t => t.id === id);
        if (!trans) return;
        document.getElementById('projectId').value = trans.project_id;
        document.getElementById('transactionDate').value = trans.transaction_date;
        document.getElementById('transactionType').value = trans.transaction_type;
        document.getElementById('description').value = trans.description;
        document.getElementById('amount').value = trans.amount;
        document.getElementById('hours').value = trans.hours || '';
        document.getElementById('rate').value = trans.rate || '';
        document.getElementById('notes').value = trans.notes || '';
        toggleTimeFields();
        calculateAmount();
        currentEditId = id;
        document.getElementById('submitBtn').textContent = 'Update Transaction';
        document.getElementById('formTitle').textContent = 'Edit Transaction';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteTransaction(id) {
        if (!confirm('Are you sure you want to delete this transaction?')) return;
        try {
            const response = await fetch(`${API_BASE}/transactions/${id}`, { method: 'DELETE' });
            if (response.ok) { showSuccess('Transaction deleted!'); loadTransactions(); }
            else showError('Failed to delete transaction');
        } catch (error) { showError('Failed to delete transaction'); }
    }

    async function loadTransactions() {
        try {
            const projectFilter = document.getElementById('filterProject').value;
            const typeFilter = document.getElementById('filterType').value;
            let url = `${API_BASE}/transactions`;
            const params = new URLSearchParams();
            if (projectFilter) params.append('project_id', projectFilter);
            if (typeFilter) params.append('type', typeFilter);
            if (params.toString()) url += '?' + params.toString();
            const response = await fetch(url);
            transactions = await response.json();
            renderTransactions();
        } catch (error) { showError('Failed to load transactions'); }
    }

    function renderTransactions() {
        const container = document.getElementById('transactionsTable');
        const totalContainer = document.getElementById('totalAmount');
        if (transactions.length === 0) {
            container.innerHTML = '<div class="empty-state">No transactions found.</div>';
            totalContainer.innerHTML = '';
            return;
        }
        let html = '<table><thead><tr><th>Date</th><th>Project</th><th>Type</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
        let total = 0;
        transactions.forEach(t => {
            total += t.amount;
            const typeClass = 'type-' + t.transaction_type.toLowerCase();
            html += '<tr>';
            html += `<td>${t.transaction_date}</td>`;
            html += `<td><strong>${t.project_name}</strong><br><small style="color:var(--color-text-muted);">${t.project_code}</small></td>`;
            html += `<td><span class="type-badge ${typeClass}">${t.transaction_type}</span></td>`;
            html += `<td>${t.description}`;
            if (t.transaction_type === 'Time' && t.hours && t.rate) {
                html += `<br><small style="color:var(--color-text-muted);">${t.hours} hrs @ $${t.rate}/hr</small>`;
            }
            html += `</td>`;
            html += `<td class="currency">$${t.amount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
            html += `<td><div class="action-buttons">`;
            html += `<button class="action-btn secondary" onclick="editTransaction(${t.id})">Edit</button>`;
            html += `<button class="action-btn danger" onclick="deleteTransaction(${t.id})">Delete</button>`;
            html += `</div></td></tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        totalContainer.innerHTML = `Total: <span class="currency">$${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>`;
    }

    function showSuccess(msg) {
        const el = document.getElementById('successMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function showError(msg) {
        const el = document.getElementById('errorMessage');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    loadProjects();
    loadTransactions();
</script>
{% endblock %}
