{% extends "base.html" %}

{% block title %}Dashboard - QMS Projects{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Project Dashboard</h1>
    <p class="subtitle">Budget-based weighted hour allocation system</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="totalProjects">{{ stats.active_projects }}</div>
        <div class="stat-label">Active Projects</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalBudget">${{ '{:,.0f}'.format(stats.total_budget) }}</div>
        <div class="stat-label">Total Budget</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="budgetRemaining">${{ '{:,.0f}'.format(stats.budget_remaining) }}</div>
        <div class="stat-label">Budget Remaining</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="monthHours">0</div>
        <div class="stat-label">Hours This Month</div>
    </div>
</div>

<div class="main-grid-equal">
    <div class="card">
        <h2>Monthly Projection</h2>
        <div class="month-selector">
            <label>Month:</label>
            <input type="month" id="monthDate">
            <button onclick="loadMonthProjection()">Load</button>
        </div>
        <div id="allocationResults"><div class="loading">Select a month to load projection data.</div></div>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <div class="quick-links">
            <a href="{{ url_for('projects.projects_page') }}" class="quick-link">
                <span class="quick-link-icon">+</span>
                <span class="quick-link-label">Add Project</span>
            </a>
            <a href="{{ url_for('projects.business_units_page') }}" class="quick-link">
                <span class="quick-link-icon">+</span>
                <span class="quick-link-label">Add Business Unit</span>
            </a>
            <a href="{{ url_for('projects.projects_page') }}#import" class="quick-link">
                <span class="quick-link-icon">^</span>
                <span class="quick-link-label">Import Projects</span>
            </a>
        </div>

        <h3 style="margin-top: 25px; margin-bottom: 15px; color: #2c3e50; font-size: 16px;">Recent Projects</h3>
        <div id="recentProjects"><div class="loading">Loading...</div></div>
    </div>
</div>

<div class="card">
    <h2>Active Projects Overview</h2>
    <div id="projectsOverview"><div class="loading">Loading projects...</div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const STAGES = {{ stages|tojson }};
    let projects = [];
    const API_BASE = '/projects/api';

    function getCurrentMonth() {
        return new Date().toISOString().slice(0, 7);
    }

    document.getElementById('monthDate').value = getCurrentMonth();

    async function loadProjects() {
        try {
            const response = await fetch(`${API_BASE}/projects`);
            projects = await response.json();
            renderProjectsOverview();
            renderRecentProjects();
            loadMonthProjection();
        } catch (error) {
            console.error('Error loading projects:', error);
        }
    }

    function getStageClass(stage) {
        return 'stage-' + stage.toLowerCase().replace(/[\s-]+/g, '').replace(/[^a-z]/g, '');
    }

    function isActiveStage(stage) {
        return ['Course of Construction', 'Pre-Construction', 'Construction and Bidding'].includes(stage);
    }

    function renderRecentProjects() {
        const container = document.getElementById('recentProjects');
        const recent = projects.slice(0, 5);
        if (recent.length === 0) {
            container.innerHTML = '<div class="empty-state">No projects yet</div>';
            return;
        }
        let html = '<table><thead><tr><th>Project</th><th>Stage</th></tr></thead><tbody>';
        recent.forEach(p => {
            html += `<tr>
                <td><strong>${p.name}</strong>${p.description ? '<div style="color:#7f8c8d;font-size:12px;">' + p.description + '</div>' : ''}<small style="color:#7f8c8d;">${p.number || p.code}</small></td>
                <td><span class="status-badge ${getStageClass(p.stage)}">${p.stage}</span></td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderProjectsOverview() {
        const container = document.getElementById('projectsOverview');
        const activeProjects = projects.filter(p => isActiveStage(p.stage));
        if (activeProjects.length === 0) {
            container.innerHTML = '<div class="empty-state">No active projects. <a href="/projects/manage">Add a project</a> to get started.</div>';
            return;
        }
        let html = '<table><thead><tr><th>Project</th><th>Manager</th><th>Budget</th><th>Spent</th><th>Remaining</th></tr></thead><tbody>';
        activeProjects.forEach(project => {
            const remaining = (project.total_budget || 0) - (project.budget_spent || 0);
            const percentSpent = (project.total_budget || 0) > 0 ? ((project.budget_spent || 0) / project.total_budget) * 100 : 0;
            const barClass = percentSpent > 90 ? 'danger' : percentSpent > 70 ? 'warning' : '';
            html += '<tr>';
            html += `<td><strong>${project.name}</strong>${project.description ? '<div style="color:#7f8c8d;font-size:12px;">' + project.description + '</div>' : ''}<small style="color:#7f8c8d;">${project.number || project.code}</small></td>`;
            html += `<td>${project.manager || '-'}</td>`;
            html += `<td class="currency">$${(project.total_budget || 0).toLocaleString()}</td>`;
            html += `<td>$${(project.budget_spent || 0).toLocaleString()}<div class="budget-bar"><div class="budget-fill ${barClass}" style="width:${percentSpent}%"></div></div></td>`;
            html += `<td class="currency">$${remaining.toLocaleString()}</td>`;
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function loadMonthProjection() {
        const container = document.getElementById('allocationResults');
        const monthValue = document.getElementById('monthDate').value;
        if (!monthValue) {
            container.innerHTML = '<div class="empty-state">Please select a month.</div>';
            return;
        }
        const [year, month] = monthValue.split('-').map(Number);
        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

        try {
            // Find the period for this month
            const periodsRes = await fetch(`${API_BASE}/projection-periods`);
            const periods = await periodsRes.json();
            const period = periods.find(p => p.year === year && p.month === month);

            if (!period) {
                container.innerHTML = `<div class="empty-state">No projection saved for ${monthNames[month-1]} ${year}.<br><a href="/projects/projections">Go to Projections page</a></div>`;
                document.getElementById('monthHours').textContent = '0';
                return;
            }

            // Get active snapshot
            const snapRes = await fetch(`${API_BASE}/projections/${period.id}`);
            if (!snapRes.ok) {
                container.innerHTML = `<div class="empty-state">No active snapshot for ${monthNames[month-1]} ${year}.<br><a href="/projects/projections">Go to Projections page</a></div>`;
                document.getElementById('monthHours').textContent = '0';
                return;
            }

            const snap = await snapRes.json();
            const statusBadge = snap.status === 'Committed'
                ? '<span class="status-badge status-committed">Committed</span>'
                : '<span class="status-badge status-draft">Draft</span>';

            let html = '<div class="allocation-summary">';
            html += `<div class="allocation-summary-item"><span>Month:</span><span>${monthNames[month-1]} ${year} ${statusBadge}</span></div>`;
            html += `<div class="allocation-summary-item"><span>Working Days:</span><span>${period.working_days || 0} days</span></div>`;
            html += `<div class="allocation-summary-item"><span>Total Hours:</span><span>${snap.total_hours || 0} hrs</span></div>`;
            html += `<div class="allocation-summary-item"><span>Total Cost:</span><span>$${(snap.total_projected_cost || 0).toLocaleString()}</span></div>`;
            html += '</div>';

            (snap.entries || []).forEach(entry => {
                html += '<div class="allocation-item">';
                html += `<div><span class="allocation-project">${entry.project_name || 'Unknown'}</span>`;
                html += `<br><small style="color:#7f8c8d;">${entry.project_code || ''}</small></div>`;
                html += `<div class="allocation-hours">${entry.allocated_hours || 0} hrs</div>`;
                html += '</div>';
            });

            html += `<div style="margin-top:15px;padding-top:15px;border-top:2px solid #ecf0f1;text-align:right;">`;
            html += `<strong>Total: ${snap.total_hours || 0} hours</strong></div>`;
            container.innerHTML = html;
            document.getElementById('monthHours').textContent = snap.total_hours || 0;
        } catch (error) {
            container.innerHTML = '<div class="empty-state">Failed to load projection data.</div>';
            console.error('Error loading projection:', error);
        }
    }

    loadProjects();
</script>
{% endblock %}
